<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Order Details</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    /* General Layout */
    * {
      box-sizing: border-box;
    }

    body {
      background-color: #ffffff;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      color: #000000;
    }

    .admin-layout {
      display: flex;
      min-height: 100vh;
    }

    /* Main Content */
    .main-content {
      flex: 1;
      padding: 20px;
      background-color: #fff;
      overflow-x: auto;
    }

    /* Page Header */
    h2 {
      font-weight: 600;
      color: #000000;
      margin-bottom: 1.5rem;
    }

    /* Order Summary */
    .order-summary p {
      margin: 0.25rem 0;
      font-size: 1rem;
    }

    .order-summary strong {
      color: #000000;
    }

    /* Status Form */
    .status-form {
      margin-bottom: 2rem;
    }

    .status-form label {
      font-weight: 600;
      margin-right: 0.75rem;
      color: #000000;
    }

    .status-form select.form-select {
      font-size: 0.9rem;
      max-width: 200px;
    }

    /* Products Section */
    .products-section h5 {
      color: #000000;
      margin-bottom: 1rem;
      font-weight: 600;
    }

    /* Table Styling */
    .table {
      background-color: #fff;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-bottom: 2rem;
    }

    .table th {
      background-color: #000000;
      color: #ffffff;
      font-weight: 600;
      border: none;
      padding: 1rem;
    }

    .table td {
      vertical-align: middle;
      padding: 1rem;
      border-color: #000000;
    }

    .table tbody tr:hover {
      background-color: #f5f5f5;
    }

    /* Status Badges */
    .badge {
      font-size: 0.8rem;
      padding: 0.5em 0.75em;
    }

    /* Buttons */
    .btn-sm {
      padding: 0.375rem 0.75rem;
      font-size: 0.875rem;
      border-radius: 0.375rem;
    }

    .btn-group-sm .btn {
      min-width: 40px;
      padding: 0.25rem 0.5rem;
    }

    /* Product Cards */
    .products-section .card {
      border: 2px solid #000000;
      box-shadow: none;
      transition: box-shadow 0.3s ease;
      background-color: #ffffff;
    }

    .products-section .card:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .products-section .card-header {
      border-bottom: 2px solid #000000;
      padding: 1rem 1.25rem;
      background-color: #f8f9fa;
    }

    .products-section .card-body {
      padding: 1.25rem;
    }

    /* Summary Cards */
    .card {
      border: 2px solid #000000;
      background-color: #ffffff;
    }
    
    .card-header.bg-primary {
      background-color: #000000 !important;
      color: #ffffff !important;
      border-bottom: 2px solid #000000;
    }
    
    .card-header.bg-info {
      background-color: #ffffff !important;
      color: #000000 !important;
      border: 2px solid #000000;
      border-bottom: 2px solid #000000;
    }

    .card-header h6 {
      margin: 0;
      font-weight: 600;
    }

    /* Pricing Table */
    .table-borderless td {
      border: none;
      padding: 0.5rem 0;
      color: #000000;
    }

    .table-borderless .border-top td {
      border-top: 2px solid #000000 !important;
      padding-top: 0.75rem;
    }

    /* Status Alerts */
    .alert {
      border: 2px solid #000000;
      border-radius: 8px;
      background-color: #ffffff;
      color: #000000;
    }

    .alert-warning {
      background-color: #ffffff;
      color: #000000;
      border-color: #000000;
    }

    .alert-info {
      background-color: #f8f9fa;
      color: #000000;
      border-color: #000000;
    }

    .alert-success {
      background-color: #f8f9fa;
      color: #000000;
      border-color: #000000;
    }

    .alert-secondary {
      background-color: #f8f9fa;
      color: #000000;
      border-color: #000000;
    }

    /* Popover Button */
    .btn-info[data-bs-toggle="popover"] {
      border: none;
      background: transparent;
      color: #0dcaf0;
      padding: 0.25rem;
    }

    .btn-info[data-bs-toggle="popover"]:hover {
      background-color: rgba(13, 202, 240, 0.1);
    }

    /* Modal Customization */
    .modal-header {
      background-color: #ffffff;
      border-bottom: 2px solid #000000;
      padding: 1rem 1.5rem;
    }

    .modal-title {
      font-weight: 600;
      color: #000000;
    }
    
    .modal-content {
      border: 2px solid #000000;
    }

    .modal-body {
      padding: 1.5rem;
    }

    .modal-footer {
      padding: 1rem 1.5rem;
      border-top: 2px solid #000000;
    }

    .modal-footer .btn {
      min-width: 100px;
    }

    .form-label {
      font-weight: 500;
      margin-bottom: 0.5rem;
      display: block;
    }

    /* Responsive Design */
    @media (max-width: 992px) {
      .main-content {
        padding: 15px;
      }
      
      h2 {
        font-size: 1.5rem;
      }
    }

    @media (max-width: 768px) {
      .admin-layout {
        flex-direction: column;
      }
      
      .main-content {
        padding: 10px;
      }

      .status-form {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        align-items: flex-start;
      }

      .status-form select.form-select {
        width: 100%;
        max-width: none;
      }

      /* Mobile Table */
      .table thead {
        display: none;
      }

      .table, 
      .table tbody, 
      .table tr, 
      .table td {
        display: block;
        width: 100%;
      }

      .table tr {
        margin-bottom: 1.5rem;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 1rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      }

      .table td {
        text-align: right;
        padding: 0.75rem 1rem 0.75rem 50%;
        position: relative;
        border: none;
      }

      .table td::before {
        content: attr(data-label);
        position: absolute;
        left: 1rem;
        width: 45%;
        padding-right: 1rem;
        white-space: nowrap;
        font-weight: 600;
        color: #495057;
        text-align: left;
      }

      /* Mobile button adjustments */
      .btn-group-sm {
        justify-content: flex-end;
        gap: 0.5rem;
      }

      .btn-sm {
        flex: 1;
        min-width: auto;
      }
    }

    @media (max-width: 576px) {
      .container {
        padding: 0;
      }
      
      h2 {
        font-size: 1.25rem;
      }
      
      .table td {
        padding-left: 40%;
      }
      
      .table td::before {
        width: 35%;
      }
    }

    /* Container adjustments */
    .container {
      max-width: 1200px;
    }

    /* Button Styles */
    .btn-success {
      background-color: #000000;
      border-color: #000000;
      color: #ffffff;
    }
    
    .btn-success:hover {
      background-color: #333333;
      border-color: #333333;
    }
    
    .btn-danger {
      background-color: #ffffff;
      border: 2px solid #000000;
      color: #000000;
    }
    
    .btn-danger:hover {
      background-color: #f5f5f5;
      border-color: #000000;
      color: #000000;
    }
    
    .btn-secondary {
      background-color: #f8f9fa;
      border: 2px solid #000000;
      color: #000000;
    }
    
    .btn-secondary:hover {
      background-color: #e9ecef;
      border-color: #000000;
      color: #000000;
    }

    /* Badge Styles */
    .badge {
      border: 1px solid #000000;
    }
    
    .badge.bg-success {
      background-color: #000000 !important;
      color: #ffffff;
    }
    
    .badge.bg-warning {
      background-color: #ffffff !important;
      color: #000000;
      border: 2px solid #000000;
    }
    
    .badge.bg-danger {
      background-color: #ffffff !important;
      color: #000000;
      border: 2px solid #000000;
    }
    
    .badge.bg-info {
      background-color: #f8f9fa !important;
      color: #000000;
      border: 2px solid #000000;
    }
    
    .badge.bg-secondary {
      background-color: #f8f9fa !important;
      color: #000000;
      border: 2px solid #000000;
    }
    
    .badge.bg-primary {
      background-color: #000000 !important;
      color: #ffffff;
    }
    
    .badge.bg-dark {
      background-color: #000000 !important;
      color: #ffffff;
    }

    /* Form Controls */
    .form-select, .form-control {
      border: 2px solid #000000;
      color: #000000;
    }
    
    .form-select:focus, .form-control:focus {
      border-color: #000000;
      box-shadow: 0 0 0 0.2rem rgba(0, 0, 0, 0.25);
    }

    /* Print styles */
    @media print {
      .admin-layout {
        display: block;
      }
      
      .sidebar {
        display: none;
      }
      
      body * {
        visibility: hidden;
      }
      
      .main-content, .main-content * {
        visibility: visible;
      }
      
      .main-content {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="admin-layout">
    <%- include('../partials/sidebar') %>

    <div class="main-content">
      <%- include('../partials/adminNavbar', { pageTitle: 'Order Detail'}) %>

      <a href="/admin/orders" class="btn btn-outline-dark mt-2" style="border: 2px solid #000000; color: #000000; background-color: #ffffff;">Go to Orders</a>

      
      <div class="container py-3">
        <h2>Order #<%= order.order_number %></h2>

        <!-- Order Summary -->
        <div class="order-summary mb-4">
          <div class="row">
            <div class="col-md-6">
              <p><strong>Order Status:</strong> 
                <% if (order.status === 'PENDING') { %>
                  <span class="badge bg-secondary">Pending</span>
                <% } else if (order.status === 'IN_PROGRESS') { %>
                  <span class="badge bg-primary">In Progress</span>
                <% } else if (order.status === 'DELIVERED') { %>
                  <span class="badge bg-success">Delivered</span>
                <% } else if (order.status === 'CANCELLED') { %>
                  <span class="badge bg-danger">Cancelled</span>
                <% } else if (order.status === 'PARTIALLY_DELIVERED') { %>
                  <span class="badge bg-warning">Partially Delivered</span>
                <% } else if (order.status === 'PARTIALLY_SHIPPED') { %>
                  <span class="badge bg-info">Partially Shipped</span>
                <% } else if (order.status === 'RETURNED') { %>
                  <span class="badge bg-dark">Returned</span>
                <% } else { %>
                  <span class="badge bg-secondary"><%= order.status %></span>
                <% } %>
              </p>
              <p><strong>Order Date:</strong> <%= formatDate(order.ordered_at || order.createdAt) %></p>
              <% if (order.delivered_at) { %>
                <p><strong>Delivered Date:</strong> <%= formatDate(order.delivered_at) %></p>
              <% } %>
            </div>
            <div class="col-md-6">
              <p><strong>Customer:</strong> <%= order.user_id ? order.user_id.firstName + ' ' + (order.user_id.lastName || '') : 'Guest' %></p>
              <p><strong>Payment Method:</strong> <%= order.payment_method || 'N/A' %></p>
              <p><strong>Total Amount:</strong> Rs<%= order.total.toLocaleString() %></p>
            </div>
          </div>
        </div>

        <!-- Order Summary -->
        <div class="row mb-4">
          <div class="col-md-6">
            <div class="card">
              <div class="card-header bg-primary text-white">
                <h6 class="mb-0"><i class="fas fa-receipt me-2"></i>Order Summary</h6>
              </div>
              <div class="card-body">
                <table class="table table-sm table-borderless">
                  <tr>
                    <td><strong>Subtotal:</strong></td>
                    <td class="text-end">Rs<%= (order.subtotal || 0).toLocaleString() %></td>
                  </tr>
                  <% if (order.coupon_discount && order.coupon_discount > 0) { %>
                    <tr>
                      <td><strong>Coupon Discount:</strong></td>
                      <td class="text-end text-success">-Rs<%= order.coupon_discount.toLocaleString() %></td>
                    </tr>
                    <% if (order.applied_coupon_code) { %>
                      <tr>
                        <td><small class="text-muted">Coupon Code:</small></td>
                        <td class="text-end"><small class="badge bg-secondary"><%= order.applied_coupon_code %></small></td>
                      </tr>
                    <% } %>
                  <% } %>
                  <tr>
                    <td><strong>Shipping:</strong></td>
                    <td class="text-end">Rs<%= (order.shipping_charge || 0).toLocaleString() %></td>
                  </tr>
                  <% if (order.tax && order.tax > 0) { %>
                    <tr>
                      <td><strong>Tax:</strong></td>
                      <td class="text-end">Rs<%= order.tax.toLocaleString() %></td>
                    </tr>
                  <% } %>
                  <tr class="border-top">
                    <td><strong>Total Amount:</strong></td>
                    <td class="text-end"><strong class="text-primary fs-5">Rs<%= order.total.toLocaleString() %></strong></td>
                  </tr>
                </table>
              </div>
            </div>
          </div>
          
          <div class="col-md-6">
            <div class="card">
              <div class="card-header bg-info text-white">
                <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>Order Status</h6>
              </div>
              <div class="card-body">
                <% 
                  let cancelledItems = 0;
                  let returnedItems = 0;
                  let deliveredItems = 0;
                  let totalItems = order.products.length;
                  
                  order.products.forEach(p => {
                    if (p.status === 'CANCELLED') cancelledItems++;
                    else if (p.status === 'RETURNED') returnedItems++;
                    else if (p.status === 'DELIVERED') deliveredItems++;
                  });
                %>
                
                <table class="table table-sm table-borderless">
                  <tr>
                    <td><strong>Total Items:</strong></td>
                    <td class="text-end"><%= totalItems %></td>
                  </tr>
                  <% if (deliveredItems > 0) { %>
                    <tr>
                      <td><strong>Delivered:</strong></td>
                      <td class="text-end text-success"><%= deliveredItems %></td>
                    </tr>
                  <% } %>
                  <% if (cancelledItems > 0) { %>
                    <tr>
                      <td><strong>Cancelled:</strong></td>
                      <td class="text-end text-danger"><%= cancelledItems %></td>
                    </tr>
                  <% } %>
                  <% if (returnedItems > 0) { %>
                    <tr>
                      <td><strong>Returned:</strong></td>
                      <td class="text-end text-warning"><%= returnedItems %></td>
                    </tr>
                  <% } %>
                  <tr class="border-top">
                    <td><strong>Payment Status:</strong></td>
                    <td class="text-end">
                      <% if (order.payment_status === 'COMPLETED') { %>
                        <span class="badge bg-success">Paid</span>
                      <% } else if (order.payment_status === 'PENDING') { %>
                        <span class="badge bg-warning">Pending</span>
                      <% } else { %>
                        <span class="badge bg-danger">Failed</span>
                      <% } %>
                    </td>
                  </tr>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- Order Status Info
        <div class="alert alert-secondary mb-4">
          <h6><i class="fas fa-info-circle me-2"></i>Order Status Management</h6>
          <p class="mb-2">The overall order status is automatically calculated based on individual product statuses. Update each product's status below to manage the order.</p>
          <% if (order.coupon_discount && order.coupon_discount > 0) { %>
            <hr style="border-color: #000000;">
            <h6><i class="fas fa-tag me-2"></i>Coupon Refund Policy</h6>
            <p class="mb-0"><strong>Important:</strong> When a product is cancelled or returned, the coupon discount allocated to that specific product is automatically deducted from the refund amount. This ensures fair distribution of coupon benefits across remaining active products.</p>
          <% } %>
        </div> -->

        <!-- Products Section -->
        <div class="products-section">
          <h5>Order Products</h5>
          
          <% order.products.forEach((p, index) => { %>
            <div class="card mb-4">
              <div class="card-header bg-light">
                <div class="row align-items-center">
                  <div class="col-md-8">
                    <div class="d-flex align-items-center">
                      <% if (p.images && p.images.length > 0) { %>
                        <img src="<%= p.images[0] %>" alt="<%= p.name %>" style="width: 60px; height: 60px; object-fit: cover; border-radius: 8px; margin-right: 15px;">
                      <% } %>
                      <div>
                        <h6 class="mb-1"><%= p.name %></h6>
                        <% if (p.color || p.size) { %>
                          <small class="text-muted">
                            <% if (p.color) { %>Color: <%= p.color %><% } %>
                            <% if (p.color && p.size) { %> | <% } %>
                            <% if (p.size) { %>Size: <%= p.size %><% } %>
                          </small>
                        <% } %>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-4 text-end">
                    <% if (p.status === 'RETURN_REQUESTED') { %>
                      <span class="badge bg-warning fs-6">Return Requested</span>
                    <% } else if (p.status === 'RETURNED') { %>
                      <span class="badge bg-info fs-6">Returned</span>
                    <% } else if (p.status === 'CANCELLED') { %>
                      <span class="badge bg-danger fs-6">Cancelled</span>
                    <% } else if (p.status === 'DELIVERED') { %>
                      <span class="badge bg-success fs-6">Delivered</span>
                    <% } else if (p.status === 'OUT_FOR_DELIVERY') { %>
                      <span class="badge bg-primary fs-6">Out for Delivery</span>
                    <% } else if (p.status === 'SHIPPED') { %>
                      <span class="badge bg-secondary fs-6">Shipped</span>
                    <% } else { %>
                      <span class="badge bg-dark fs-6">Ordered</span>
                    <% } %>
                  </div>
                </div>
              </div>
              
              <div class="card-body">
                <div class="row">
                  <!-- Product Details -->
                  <div class="col-md-6">
                    <h6 class="text-primary mb-3"><i class="fas fa-info-circle me-2"></i>Product Details</h6>
                    <table class="table table-sm table-borderless">
                      <tr>
                        <td><strong>Quantity:</strong></td>
                        <td class="text-end"><%= p.quantity %></td>
                      </tr>
                      <tr>
                        <td><strong>Unit Price:</strong></td>
                        <td class="text-end">Rs<%= p.price.toLocaleString() %></td>
                      </tr>
                      <tr>
                        <td><strong>Total Amount:</strong></td>
                        <td class="text-end"><strong class="text-primary">Rs<%= (p.price * p.quantity).toLocaleString() %></strong></td>
                      </tr>
                      <% if (p.appliedOfferType) { %>
                        <tr>
                          <td><strong>Applied Offer:</strong></td>
                          <td class="text-end"><small style="color: #000000;"><%= p.appliedOfferType %></small></td>
                        </tr>
                      <% } %>
                      <% if (p.coupon_discount_allocated && p.coupon_discount_allocated > 0) { %>
                        <tr>
                          <td><strong>Coupon Share:</strong></td>
                          <td class="text-end"><small style="color: #000000;">Rs<%= p.coupon_discount_allocated.toLocaleString() %></small></td>
                        </tr>
                      <% } %>
                    </table>
                  </div>
                  
                  <!-- Status & Actions -->
                  <div class="col-md-6">
                    <h6 class="text-success mb-3"><i class="fas fa-cogs me-2"></i>Status & Actions</h6>
                    
                    <!-- Status Change -->
                    <div class="mb-3">
                      <label class="form-label"><strong>Change Status:</strong></label>
                      <% if (p.status !== 'RETURN_REQUESTED' && p.status !== 'RETURNED' && p.status !== 'CANCELLED') { %>
                        <form class="product-status-form" data-order-id="<%= order._id %>" data-product-id="<%= p._id %>">
                          <select name="status" class="form-select form-select-sm" onchange="updateProductStatus(this)">
                            <option value="ORDERED" <%= p.status === 'ORDERED' || !p.status ? 'selected' : '' %>>Ordered</option>
                            <option value="SHIPPED" <%= p.status === 'SHIPPED' ? 'selected' : '' %>>Shipped</option>
                            <option value="OUT_FOR_DELIVERY" <%= p.status === 'OUT_FOR_DELIVERY' ? 'selected' : '' %>>Out for Delivery</option>
                            <option value="DELIVERED" <%= p.status === 'DELIVERED' ? 'selected' : '' %>>Delivered</option>
                          </select>
                        </form>
                      <% } else { %>
                        <div class="alert alert-warning py-2">
                          <small><i class="fas fa-lock me-1"></i>Status locked - Product is <%= p.status.toLowerCase().replace('_', ' ') %></small>
                        </div>
                      <% } %>
                    </div>

                    <!-- Refund Information -->
                    <% if (p.status === 'CANCELLED' || p.status === 'RETURNED') { %>
                      <div class="alert alert-info py-2">
                        <small>
                          <i class="fas fa-info-circle me-1"></i>
                          <% 
                            let refundAmount = 0;
                            if (p.status === 'RETURNED' && p.return_details && p.return_details.refundAmount) {
                              refundAmount = p.return_details.refundAmount;
                            } else if (p.status === 'CANCELLED') {
                              refundAmount = (p.price * p.quantity) - (p.coupon_discount_allocated || 0);
                            }
                          %>
                          <% if (p.status === 'CANCELLED') { %>
                            <strong>Cancelled:</strong> Rs<%= refundAmount.toLocaleString() %> refunded to wallet
                          <% } else { %>
                            <strong>Returned:</strong> Rs<%= refundAmount.toLocaleString() %> refunded to wallet
                          <% } %>
                          <% if (p.coupon_discount_allocated && p.coupon_discount_allocated > 0) { %>
                            <br><strong>Note:</strong> Coupon discount (Rs<%= p.coupon_discount_allocated.toLocaleString() %>) deducted from refund
                          <% } %>
                          <% if (p.status === 'RETURNED' && p.return_details) { %>
                            <br><strong>Reason:</strong> <%= p.return_details.reason %>
                          <% } %>
                        </small>
                      </div>
                    <% } %>

                    <!-- Return Request Actions -->
                    <% if (p.status === 'RETURN_REQUESTED') { %>
                      <div class="alert alert-warning py-2">
                        <h6 class="mb-2"><i class="fas fa-undo me-2"></i>Return Request</h6>
                        <% if (p.return_details) { %>
                          <small class="d-block mb-2">
                            <strong>Reason:</strong> <%= p.return_details.reason %><br>
                            <strong>Requested:</strong> <%= formatDate(p.return_details.requested_at) %>
                          </small>
                        <% } %>
                        <div class="d-flex gap-2">
                          <button class="btn btn-success btn-sm" onclick="verifyReturn('<%= order._id %>', '<%= p._id %>', 'approve')" title="Approve Return">
                            <i class="fas fa-check me-1"></i>Approve
                          </button>
                          <button class="btn btn-danger btn-sm" onclick="verifyReturn('<%= order._id %>', '<%= p._id %>', 'reject')" title="Reject Return">
                            <i class="fas fa-times me-1"></i>Reject
                          </button>
                        </div>
                      </div>
                    <% } else if (p.status === 'RETURNED') { %>
                      <div class="alert alert-success py-2">
                        <small><i class="fas fa-check-circle me-1"></i>Return approved - Amount refunded to wallet</small>
                      </div>
                    <% } %>
                  </div>
                </div>
              </div>
            </div>
          <% }) %>
        </div>

        <!-- Shipping Address -->
        <% if (order.shipping_address) { %>
          <div class="card mb-4">
            <div class="card-header bg-secondary text-white">
              <h6 class="mb-0"><i class="fas fa-shipping-fast me-2"></i>Shipping Address</h6>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6">
                  <p class="mb-1"><strong><%= order.shipping_address.name %></strong></p>
                  <% if (order.shipping_address.house_number) { %>
                    <p class="mb-1"><%= order.shipping_address.house_number %></p>
                  <% } %>
                  <% if (order.shipping_address.street) { %>
                    <p class="mb-1"><%= order.shipping_address.street %></p>
                  <% } %>
                  <% if (order.shipping_address.locality) { %>
                    <p class="mb-1"><%= order.shipping_address.locality %></p>
                  <% } %>
                  <p class="mb-1"><%= order.shipping_address.city %>, <%= order.shipping_address.state %></p>
                  <p class="mb-1"><strong>PIN:</strong> <%= order.shipping_address.pincode %></p>
                </div>
                <div class="col-md-6">
                  <p class="mb-1"><strong>Phone:</strong> <%= order.shipping_address.phone_number %></p>
                  <!-- <% if (order.shipping_address.type) { %>
                    <p class="mb-1"><strong>Address Type:</strong> 
                      <span class="badge bg-outline-secondary"><%= order.shipping_address.type %></span>
                    </p>
                  <% } %> -->
                  <% if (order.shipping_address.type) { %>
                    <p class="mb-1"><strong>Address Type:</strong> <%= order.shipping_address.type %></p>
                  <% } %>
                </div>
              </div>
            </div>
          </div>
        <% } %>

        <!-- Cancel Modal -->
        <div class="modal fade" id="cancelModal" tabindex="-1">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Cancel Order</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <input type="hidden" id="cancelProductId">
                <label for="cancelReason" class="form-label">Reason (optional)</label>
                <textarea class="form-control" id="cancelReason" rows="3"></textarea>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="submitCancel()">Submit</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Return Modal -->
        <div class="modal fade" id="returnModal" tabindex="-1">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Return Product</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <input type="hidden" id="returnProductId">
                <label for="returnReason" class="form-label">Reason <span class="text-danger">*</span></label>
                <textarea class="form-control" id="returnReason" rows="3" required></textarea>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" onclick="submitReturn()">Submit</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    function openCancelModal(productId) {
      document.getElementById('cancelProductId').value = productId;
      new bootstrap.Modal(document.getElementById('cancelModal')).show();
    }

    function openReturnModal(productId) {
      document.getElementById('returnProductId').value = productId;
      new bootstrap.Modal(document.getElementById('returnModal')).show();
    }

    // Update product status with PATCH method
    function updateProductStatus(selectElement) {
      const form = selectElement.closest('.product-status-form');
      const orderId = form.dataset.orderId;
      const productId = form.dataset.productId;
      const status = selectElement.value;

      // Show loading state
      selectElement.disabled = true;

      fetch(`/admin/orders/${orderId}/product-status`, {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          productId: productId,
          status: status
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Success - reload page to show updated status
          location.reload();
        } else {
          // Show specific error message
          if (typeof Swal !== 'undefined') {
            Swal.fire({
              icon: 'error',
              title: 'Update Failed',
              text: data.message || 'Failed to update status',
              confirmButtonColor: '#d33'
            });
          } else {
            alert(data.message || 'Failed to update status');
          }
          selectElement.disabled = false;
          // Reset to previous value if needed
          location.reload();
        }
      })
      .catch(error => {
        console.error('Error:', error);
        if (typeof Swal !== 'undefined') {
          Swal.fire({
            icon: 'error',
            title: 'Network Error',
            text: 'Network error: Failed to update status',
            confirmButtonColor: '#d33'
          });
        } else {
          alert('Network error: Failed to update status');
        }
        selectElement.disabled = false;
        location.reload();
      });
    }

    // Submit cancel request with PATCH method
    function submitCancel() {
      const productId = document.getElementById('cancelProductId').value;
      const reason = document.getElementById('cancelReason').value;

      if (!reason.trim()) {
        if (typeof Swal !== 'undefined') {
          Swal.fire({
            icon: 'warning',
            title: 'Missing Information',
            text: 'Please provide a cancellation reason',
            confirmButtonColor: '#ffc107'
          });
        } else {
          alert('Please provide a cancellation reason');
        }
        return;
      }

      fetch(`/admin/orders/<%= order._id %>/cancel`, {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          productId: productId,
          reason: reason
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          bootstrap.Modal.getInstance(document.getElementById('cancelModal')).hide();
          location.reload();
        } else {
          if (typeof Swal !== 'undefined') {
            Swal.fire({
              icon: 'error',
              title: 'Cancel Failed',
              text: data.message || 'Failed to cancel order',
              confirmButtonColor: '#d33'
            });
          } else {
            alert(data.message || 'Failed to cancel order');
          }
        }
      })
      .catch(error => {
        console.error('Error:', error);
        if (typeof Swal !== 'undefined') {
          Swal.fire({
            icon: 'error',
            title: 'Network Error',
            text: 'Network error: Failed to cancel order',
            confirmButtonColor: '#d33'
          });
        } else {
          alert('Network error: Failed to cancel order');
        }
      });
    }

    // Submit return request with PATCH method
    function submitReturn() {
      const productId = document.getElementById('returnProductId').value;
      const reason = document.getElementById('returnReason').value;

      if (!reason.trim()) {
        if (typeof Swal !== 'undefined') {
          Swal.fire({
            icon: 'warning',
            title: 'Missing Information',
            text: 'Please provide a reason for return',
            confirmButtonColor: '#ffc107'
          });
        } else {
          alert('Please provide a reason for return');
        }
        return;
      }

      fetch(`/admin/orders/<%= order._id %>/return`, {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          productId: productId,
          reason: reason
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          bootstrap.Modal.getInstance(document.getElementById('returnModal')).hide();
          location.reload();
        } else {
          if (typeof Swal !== 'undefined') {
            Swal.fire({
              icon: 'error',
              title: 'Return Failed',
              text: data.message || 'Failed to process return',
              confirmButtonColor: '#d33'
            });
          } else {
            alert(data.message || 'Failed to process return');
          }
        }
      })
      .catch(error => {
        console.error('Error:', error);
        if (typeof Swal !== 'undefined') {
          Swal.fire({
            icon: 'error',
            title: 'Network Error',
            text: 'Network error: Failed to process return',
            confirmButtonColor: '#d33'
          });
        } else {
          alert('Network error: Failed to process return');
        }
      });
    }

    // Verify return with PATCH method
    function verifyReturn(orderId, productId, action) {
      fetch(`/admin/orders/${orderId}/return/verify`, {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          productId: productId,
          action: action
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          if (typeof Swal !== 'undefined') {
            Swal.fire({
              icon: 'success',
              title: 'Success',
              text: data.message,
              confirmButtonColor: '#28a745'
            }).then(() => {
              location.reload();
            });
          } else {
            alert(data.message);
            location.reload();
          }
        } else {
          if (typeof Swal !== 'undefined') {
            Swal.fire({
              icon: 'error',
              title: 'Verification Failed',
              text: data.message || 'Failed to verify return',
              confirmButtonColor: '#d33'
            });
          } else {
            alert(data.message || 'Failed to verify return');
          }
        }
      })
      .catch(error => {
        console.error('Error:', error);
        if (typeof Swal !== 'undefined') {
          Swal.fire({
            icon: 'error',
            title: 'Network Error',
            text: 'Network error: Failed to verify return',
            confirmButtonColor: '#d33'
          });
        } else {
          alert('Network error: Failed to verify return');
        }
      });
    }

    // Initialize popovers
    document.addEventListener('DOMContentLoaded', function() {
      const popoverTriggerList = document.querySelectorAll('[data-bs-toggle="popover"]');
      const popoverList = [...popoverTriggerList].map(popoverTriggerEl => 
        new bootstrap.Popover(popoverTriggerEl, {
          html: true,
          placement: 'left',
          trigger: 'hover focus'
        })
      );
    });
  </script>
</body>
</html>