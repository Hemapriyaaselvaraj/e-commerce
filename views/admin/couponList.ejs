<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Coupons - Admin</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      background-color: #f8f9fa;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
    }

    .admin-layout {
      display: flex;
      min-height: 100vh;
    }

    .main-content {
      flex: 1;
      padding: 20px;
      background-color: #fff;
      overflow-x: auto;
    }

    h2 {
      font-weight: 600;
      color: #343a40;
      margin-bottom: 1.5rem;
    }

    .header-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
    }

    .btn-create {
      background-color: #343a40;
      color: #fff;
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      text-decoration: none;
      font-weight: 500;
      transition: background-color 0.3s;
    }

    .btn-create:hover {
      background-color: #23272b;
      color: #fff;
    }

    .table {
      background-color: #fff;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-bottom: 2rem;
    }

    .table th {
      background-color: #343a40;
      color: #fff;
      font-weight: 600;
      border: none;
      padding: 1rem;
      white-space: nowrap;
    }

    .table td {
      vertical-align: middle;
      padding: 1rem;
      border-color: #dee2e6;
    }

    .table tbody tr:hover {
      background-color: #f8f9fa;
    }

    .badge {
      font-size: 0.85rem;
      padding: 0.4em 0.8em;
      font-weight: 500;
    }

    .badge-percentage {
      background-color: #0d6efd;
      color: white;
    }

    .badge-fixed {
      background-color: #198754;
      color: white;
    }

    .btn-sm {
      padding: 0.375rem 0.75rem;
      font-size: 0.875rem;
      border-radius: 0.375rem;
    }

    .btn-edit {
      background: #000;
      color: white;
      border: none;
      text-decoration: none;
      display: inline-block;
      text-align: center;
    }

    .btn-edit:hover {
      background: #333;
      color: white;
    }

    .btn-delete {
      background: #dc3545;
      color: white;
      border: none;
    }

    .btn-delete:hover {
      background: #c82333;
      color: white;
    }

    .coupon-code {
      font-family: 'Courier New', monospace;
      font-weight: 600;
      color: #343a40;
      background-color: #f8f9fa;
      padding: 4px 8px;
      border-radius: 4px;
      border: 1px dashed #dee2e6;
    }

    .date-range {
      font-size: 0.9rem;
      color: #6c757d;
    }

    .status-active {
      color: #198754;
      font-weight: 500;
    }

    .status-expired {
      color: #dc3545;
      font-weight: 500;
    }

    .status-upcoming {
      color: #ffc107;
      font-weight: 500;
    }

    @media (max-width: 992px) {
      .main-content {
        padding: 15px;
      }
      
      h2 {
        font-size: 1.5rem;
      }
    }

    @media (max-width: 768px) {
      .admin-layout {
        flex-direction: column;
      }
      
      .main-content {
        padding: 10px;
      }

      .header-actions {
        flex-direction: column;
        gap: 1rem;
        align-items: flex-start;
      }

      .table thead {
        display: none;
      }

      .table, 
      .table tbody, 
      .table tr, 
      .table td {
        display: block;
        width: 100%;
      }

      .table tr {
        margin-bottom: 1.5rem;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 1rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      }

      .table td {
        text-align: right;
        padding: 0.75rem 1rem 0.75rem 50%;
        position: relative;
        border: none;
      }

      .table td::before {
        content: attr(data-label);
        position: absolute;
        left: 1rem;
        width: 45%;
        padding-right: 1rem;
        white-space: nowrap;
        font-weight: 600;
        color: #495057;
        text-align: left;
      }
    }

    @media (max-width: 576px) {
      h2 {
        font-size: 1.25rem;
      }
      
      .table td {
        padding-left: 40%;
      }
      
      .table td::before {
        width: 35%;
      }
    }

    .container {
      max-width: 1400px;
    }
  </style>
</head>
<body>
  <div class="admin-layout">
    <%- include('../partials/sidebar') %>

    <div class="main-content">
      <%- include('../partials/adminNavbar', { pageTitle: 'Coupons Management'}) %>

      <div class="container py-3">
        <div class="header-actions">
          <h5>Coupons</h5>
          <a href="/admin/add-coupon" class="btn-create">
            <i class="fas fa-plus me-2"></i>Create New Coupon
          </a>
        </div>

        <% if (coupons && coupons.length > 0) { %>
          <table class="table table-bordered">
            <thead>
              <tr>
                <th>Code</th>
                <th>Description</th>
                <th>Discount Type</th>
                <th>Discount Value</th>
                <th>Min Purchase</th>
                <th>Max Discount</th>
                <th>Valid Period</th>
                <th>Usage Limit</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <% coupons.forEach(c => { 
                const now = new Date();
                const isActive = now >= new Date(c.validFrom) && now <= new Date(c.validTo);
                const isExpired = now > new Date(c.validTo);
                const isUpcoming = now < new Date(c.validFrom);
              %>
                <tr>
                  <td data-label="Code">
                    <span class="coupon-code"><%= c.code %></span>
                  </td>
                  
                  <td data-label="Description">
                    <%= c.description || 'N/A' %>
                  </td>
                  
                  <td data-label="Discount Type">
                    <% if (c.discountType === "PERCENTAGE") { %>
                      <span class="badge badge-percentage">Percentage</span>
                    <% } else { %>
                      <span class="badge badge-fixed">Fixed Amount</span>
                    <% } %>
                  </td>
                  
                  <td data-label="Discount Value">
                    <% if (c.discountType === "PERCENTAGE") { %>
                      <strong><%= c.discountValue %>%</strong>
                    <% } else { %>
                      <strong>₹<%= c.discountValue %></strong>
                    <% } %>
                  </td>
                  
                  <td data-label="Min Purchase">
                    ₹<%= c.minimumPurchase || 0 %>
                  </td>
                  
                  <td data-label="Max Discount">
                    <% if (c.maxDiscount) { %>
                      ₹<%= c.maxDiscount %>
                    <% } else { %>
                      <span class="text-muted">No limit</span>
                    <% } %>
                  </td>
                  
                  <td data-label="Valid Period">
                    <div class="date-range">
                      <div><i class="fas fa-calendar-alt me-1"></i><%= new Date(c.validFrom).toLocaleDateString() %></div>
                      <div><i class="fas fa-calendar-check me-1"></i><%= new Date(c.validTo).toLocaleDateString() %></div>
                    </div>
                  </td>
                  
                  <td data-label="Usage Limit">
                    <%= c.usageLimitPerUser || 'Unlimited' %>
                  </td>
                  
                  <td data-label="Status">
                    <% if (isActive) { %>
                      <span class="status-active"><i class="fas fa-check-circle me-1"></i>Active</span>
                    <% } else if (isExpired) { %>
                      <span class="status-expired"><i class="fas fa-times-circle me-1"></i>Expired</span>
                    <% } else if (isUpcoming) { %>
                      <span class="status-upcoming"><i class="fas fa-clock me-1"></i>Upcoming</span>
                    <% } %>
                  </td>
                  
                  <td data-label="Actions">
                    <a href="/admin/edit-coupon/<%= c._id %>" class="btn btn-edit btn-sm mb-1 w-100">
                      <i class="fa fa-edit me-1"></i>Edit
                    </a>
                    <button onclick="deleteCoupon('<%= c._id %>', '<%= c.code %>')" class="btn btn-delete btn-sm w-100">
                      <i class="fa fa-trash me-1"></i>Delete
                    </button>
                  </td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        <% } else { %>
          <div class="alert alert-info text-center">
            <i class="fas fa-info-circle me-2"></i>No coupons found. Create your first coupon to get started!
          </div>
        <% } %>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script>
    function deleteCoupon(id, code) {
      Swal.fire({
        title: 'Delete Coupon?',
        text: `Are you sure you want to delete coupon "${code}"? This action cannot be undone.`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#dc3545',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'Yes, delete it!',
        cancelButtonText: 'Cancel'
      }).then((result) => {
        if (result.isConfirmed) {
          fetch(`/admin/delete-coupon/${id}`, {
            method: 'DELETE',
            headers: {
              'Content-Type': 'application/json'
            }
          })
          .then(response => {
            if (response.ok) {
              Swal.fire({
                icon: 'success',
                title: 'Deleted!',
                text: 'Coupon has been deleted successfully.',
                showConfirmButton: false,
                timer: 2000,
                didClose: () => {
                  location.reload();
                }
              });
            } else {
              throw new Error('Failed to delete coupon');
            }
          })
          .catch(error => {
            console.error('Error:', error);
            Swal.fire({
              icon: 'error',
              title: 'Error!',
              text: 'Failed to delete coupon. Please try again.',
              confirmButtonColor: '#dc3545'
            });
          });
        }
      });
    }
  </script>
</body>
</html>
