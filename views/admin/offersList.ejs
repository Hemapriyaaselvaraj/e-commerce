<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Offers</title>

  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    /* Reset and layout */
    html,
    body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: 'Inter', sans-serif;
      background-color: #ffffff;
    }

    .admin-layout {
      display: flex;
      min-height: 100vh;
      background-color: #ffffff;
    }

    .main-content {
      flex-grow: 1;
      background-color: #ffffff;
      padding: 20px;
      overflow-y: auto;
    }

    /* Top bar */
    .top-bar {
      background-color: #ffffff;
      border-bottom: 1px solid #dee2e6;
    }

    .top-bar h5 {
      font-weight: 600;
    }

    /* Table styles */
    .table {
      margin-bottom: 0;
      font-size: 14px;
      background: #fff;
      border: none;
    }

    .table thead {
      background: #fafafa;
      border-bottom: 1px solid #e5e7eb;
    }

    .table thead th {
      white-space: nowrap;
      font-weight: 600;
      color: #000000;
      font-size: 13px;
      padding: 12px 16px;
      border: none;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .table tbody td {
      padding: 16px;
      border: none;
      vertical-align: middle;
      border-bottom: 1px solid #f0f0f0;
    }

    .table tbody tr {
      transition: background-color 0.2s ease;
    }

    .table tbody tr:hover {
      background: #f8f9fa;
    }

    .table tbody td h4 {
      font-size: 16px;
      font-weight: 600;
      margin: 0;
      color: #222;
    }

    .table tbody td ul {
      margin: 4px 0 0 0;
      padding-left: 20px;
      font-size: 13px;
    }

    .table tbody td ul li {
      margin-bottom: 2px;
    }

    .table-responsive {
      overflow: hidden;
    }

    /* Button styles */
    .btn-edit {
      background: #000;
      color: white;
      border: none;
      transition: all 0.2s;
    }

    .btn-edit:hover {
      background: #333;
      color: white;
    }

    .btn-toggle-active {
      background: #000;
      color: white;
      border: none;
      transition: all 0.2s;
    }

    .btn-toggle-active:hover {
      background: #333;
      color: white;
    }

    .btn-toggle-inactive {
      background: #e5e7eb;
      color: #000;
      border: none;
      transition: all 0.2s;
    }

    .btn-toggle-inactive:hover {
      background: #d1d5db;
      color: #000;
    }

    .btn-delete {
      background: #dc3545;
      color: white;
      border: none;
      transition: all 0.2s;
    }

    .btn-delete:hover {
      background: #c82333;
      color: white;
    }

    /* Badge styles */
    .badge {
      font-size: 12px;
      font-weight: 600;
      padding: 6px 12px;
    }

    .badge.bg-success {
      background-color: #10b981 !important;
    }

    .badge.bg-secondary {
      background-color: #6c757d !important;
    }

    /* Add offer button */
    .btn-dark {
      background: #000;
      border: none;
      padding: 8px 16px;
      font-weight: 500;
      transition: all 0.2s;
    }

    .btn-dark:hover {
      background: #333;
    }

    @media (max-width: 992px) {
      .top-bar {
        padding-inline: 1rem !important;
      }
    }

    @media (max-width: 768px) {
      .main-content {
        padding: 15px;
      }

      .table thead {
        font-size: 12px;
      }

      .table tbody td {
        font-size: 12px;
        padding: 12px;
      }
    }
  </style>
</head>

<body>
  <div class="container-fluid admin-layout">
    <div class="row flex-nowrap w-100">
      <%- include('../partials/sidebar') %>

      <div class="col-md-10 col-12 p-0">
        <div class="top-bar d-flex justify-content-between align-items-center py-3 px-4">
          <h5 class="mb-0">Offer Management</h5>
          <div class="d-flex align-items-center gap-3">
            <div class="d-flex align-items-center gap-2">
              <span><%= name %></span>
              <i class="fa-solid fa-user"></i>
            </div>
          </div>
        </div>

        <div class="p-2 p-md-3">
          <section class="main-content">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h6 class="mb-0 text-muted">Manage your promotional offers</h6>
              <a href="/admin/add-offer" class="btn btn-dark btn-sm">
                <i class="fa fa-plus me-1"></i> Add New Offer
              </a>
            </div>

            <div class="table-responsive">
              <table class="table align-middle">
      <thead>
        <tr>
          <th>Offer Name</th>
          <th>Discount</th>
          <th>Applied To</th>
          <th>Validity</th>
          <th>Status</th>
          <th style="width: 160px;">Actions</th>
        </tr>
      </thead>

      <tbody>
        <% if (offers.length === 0) { %>
          <tr>
            <td colspan="6" class="text-center">No offers found</td>
          </tr>
        <% } else { %>

          <% offers.forEach(o => { %>
            <tr>
              <!-- Offer Name -->
              <td><h4><%= o.offerName %></h4></td>

              <!-- Discount -->
              <td><%= o.discountPercentage %> %</td>

              <!-- Applied To -->
              <td>
                <% if (o.product.length > 0) { %>
                  <strong>Products:</strong>
                  <ul>
                    <% o.product.forEach(p => { %>
                      <li>SKU: <%= p.product_sku %> </li>
                    <% }) %>
                  </ul>
                <% } %>

                <% if (o.category.length > 0) { %>
                  <strong>Categories:</strong>
                  <ul>
                    <% o.category.forEach(c => { %>
                      <li><%= c.category %></li>
                    <% }) %>
                  </ul>
                <% } %>

                <% if (o.product.length === 0 && o.category.length === 0) { %>
                  <span class="text-muted">All Products</span>
                <% } %>
              </td>

              <!-- Validity -->
              <td>
                <%= new Date(o.validFrom).toLocaleDateString() %> <br>
                to <br>
                <%= new Date(o.validTo).toLocaleDateString() %>
              </td>

              <!-- Status -->
              <td>
                <% if (o.isActive) { %>
                  <span class="badge bg-success">Active</span>
                <% } else { %>
                  <span class="badge bg-secondary">Inactive</span>
                <% } %>
              </td>

              <!-- Actions -->
              <td>
                <a href="/admin/edit-offer/<%= o._id %>" class="btn btn-edit btn-sm mb-1 w-100">
                  <i class="fa fa-edit me-1"></i> Edit
                </a>

                <% if (o.isActive) { %>
                  <button 
                    onclick="toggleOffer('<%= o._id %>', true)" 
                    class="btn btn-toggle-inactive btn-sm mb-1 w-100"
                    id="toggle-btn-<%= o._id %>"
                  >
                    <i class="fa fa-toggle-off me-1"></i> Deactivate
                  </button>
                <% } else { %>
                  <button 
                    onclick="toggleOffer('<%= o._id %>', false)" 
                    class="btn btn-toggle-active btn-sm mb-1 w-100"
                    id="toggle-btn-<%= o._id %>"
                  >
                    <i class="fa fa-toggle-on me-1"></i> Activate
                  </button>
                <% } %>

                <button onclick="deleteOffer('<%= o._id %>', '<%= o.offerName %>')" class="btn btn-delete btn-sm w-100">
                  <i class="fa fa-trash me-1"></i> Delete
                </button>
              </td>

            </tr>
          <% }) %>

        <% } %>
      </tbody>
              </table>
            </div>
          </section>
        </div>
      </div>
    </div>
  </div>

  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script>
    function toggleOffer(id, currentStatus) {
      const btn = document.getElementById(`toggle-btn-${id}`);
      const statusBadge = btn.closest('tr').querySelector('.badge');
      
      fetch(`/admin/toggle-offer/${id}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        }
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          // Update button
          if (data.isActive) {
            btn.className = 'btn btn-toggle-inactive btn-sm mb-1 w-100';
            btn.innerHTML = '<i class="fa fa-toggle-off me-1"></i> Deactivate';
            statusBadge.className = 'badge bg-success';
            statusBadge.textContent = 'Active';
          } else {
            btn.className = 'btn btn-toggle-active btn-sm mb-1 w-100';
            btn.innerHTML = '<i class="fa fa-toggle-on me-1"></i> Activate';
            statusBadge.className = 'badge bg-secondary';
            statusBadge.textContent = 'Inactive';
          }
          
          // Update onclick attribute
          btn.setAttribute('onclick', `toggleOffer('${id}', ${data.isActive})`);
          
          // Show success message
          Swal.fire({
            icon: 'success',
            title: 'Success',
            text: `Offer ${data.isActive ? 'activated' : 'deactivated'} successfully`,
            timer: 1500,
            showConfirmButton: false
          });
        }
      })
      .catch(error => {
        console.error('Error:', error);
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: 'Failed to update offer status',
          confirmButtonColor: '#000'
        });
      });
    }

    function deleteOffer(id, name) {
      Swal.fire({
        title: 'Delete Offer?',
        text: `Are you sure you want to delete "${name}"? This action cannot be undone.`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#dc3545',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'Yes, delete it',
        cancelButtonText: 'Cancel'
      }).then((result) => {
        if (result.isConfirmed) {
          window.location.href = `/admin/delete-offer/${id}`;
        }
      });
    }
  </script>

</body>
</html>
