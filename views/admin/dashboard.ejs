<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - ToughToes</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    * {
      box-sizing: border-box;
    }

    body {
      background-color: #f8f9fa;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      color: #343a40;
    }

    .admin-layout {
      display: flex;
      min-height: 100vh;
    }

    .main-content {
      flex: 1;
      padding: 20px;
      background-color: #fff;
      overflow-x: auto;
      min-height: 100vh;
    }

    .container-fluid {
      max-width: 100%;
      margin: 0 auto;
    }

    .dashboard-header {
      margin-bottom: 2rem;
      text-align: left;
    }

    .dashboard-title {
      font-size: 2rem;
      font-weight: 600;
      color: #343a40;
      margin-bottom: 0.5rem;
    }

    .dashboard-subtitle {
      color: #6c757d;
      font-size: 1rem;
    }

    /* Stats Cards */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    @media (max-width: 1200px) {
      .stats-grid {
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      }
    }

    .stat-card {
      background: #fff;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 1.5rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .stat-card-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      margin-bottom: 1rem;
      width: 100%;
    }

    .stat-card-content {
      flex: 1;
    }

    .stat-card-title {
      font-size: 0.875rem;
      font-weight: 500;
      color: #6c757d;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .stat-card-icon {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      color: #fff;
    }

    .stat-card-icon.sales { background-color: #343a40; }
    .stat-card-icon.customers { background-color: #6c757d; }
    .stat-card-icon.orders { background-color: #495057; }

    .stat-card-value {
      font-size: 2rem;
      font-weight: 700;
      color: #343a40;
      margin-bottom: 0.25rem;
    }

    .stat-card-change {
      font-size: 0.875rem;
      color: #6c757d;
    }

    /* Chart Section */
    .chart-section {
      background: #fff;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 1.5rem;
      margin-bottom: 2rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      height: fit-content;
    }

    .chart-header {
      margin-bottom: 1rem;
    }

    .chart-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: #343a40;
      margin: 0;
    }

    .filter-section {
      border-bottom: 1px solid #dee2e6;
      padding-bottom: 1rem;
    }

    .filter-buttons {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .filter-btn {
      padding: 0.5rem 1rem;
      border: 1px solid #dee2e6;
      background: #fff;
      color: #6c757d;
      border-radius: 6px;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .filter-btn:hover {
      border-color: #343a40;
      color: #343a40;
    }

    .filter-btn.active {
      background: #343a40;
      color: #fff;
      border-color: #343a40;
    }

    .chart-container {
      height: 450px;
      width: 100%;
      position: relative;
    }

    /* Sidebar Top Lists */
    .top-lists-sidebar {
      height: 100%;
    }

    .top-lists-sidebar .top-list-card {
      background: #fff;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 1rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      height: fit-content;
    }

    .top-lists-sidebar .top-list-title {
      font-size: 1rem;
      font-weight: 600;
      color: #343a40;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      border-bottom: 1px solid #f1f3f4;
      padding-bottom: 0.5rem;
    }

    .top-lists-sidebar .top-list-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem 0;
      border-bottom: 1px solid #f8f9fa;
      font-size: 0.875rem;
    }

    .top-lists-sidebar .top-list-item:last-child {
      border-bottom: none;
    }

    .top-lists-sidebar .top-list-name {
      font-weight: 500;
      color: #343a40;
      flex: 1;
      margin-right: 0.5rem;
    }

    .top-lists-sidebar .top-list-count {
      background-color: #f8f9fa;
      color: #495057;
      padding: 0.2rem 0.5rem;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
      min-width: 30px;
      text-align: center;
    }

    .top-lists-sidebar .badge {
      font-size: 0.65rem;
      padding: 0.2rem 0.4rem;
    }

    /* Tables */
    .table-section {
      background: #fff;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 1.5rem;
      margin-bottom: 2rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      width: 100%;
      overflow-x: auto;
    }

    .table-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: #343a40;
      margin-bottom: 1rem;
    }

    .custom-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }

    .custom-table th {
      background-color: #f8f9fa;
      color: #495057;
      font-weight: 600;
      font-size: 0.875rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      padding: 1rem 0.75rem;
      border-bottom: 2px solid #dee2e6;
      text-align: center;
    }

    .custom-table td {
      padding: 1rem 0.75rem;
      border-bottom: 1px solid #dee2e6;
      text-align: center;
      vertical-align: middle;
    }

    .custom-table tbody tr:hover {
      background-color: #f8f9fa;
    }

    .order-id {
      color: #343a40;
      font-weight: 600;
      font-family: 'Courier New', monospace;
    }

    .status-badge {
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
    }

    .status-ordered { background-color: #e3f2fd; color: #1976d2; }
    .status-pending { background-color: #fff3e0; color: #f57c00; }
    .status-ordered { background-color: #fff3e0; color: #f57c00; }
    .status-in-progress { background-color: #e3f2fd; color: #1976d2; }
    .status-shipped { background-color: #f3e5f5; color: #7b1fa2; }
    .status-out-for-delivery { background-color: #e8eaf6; color: #3f51b5; }
    .status-delivered { background-color: #e8f5e8; color: #388e3c; }
    .status-cancelled { background-color: #ffebee; color: #d32f2f; }
    .status-partially-delivered { background-color: #fff8e1; color: #f9a825; }
    .status-partially-shipped { background-color: #fce4ec; color: #c2185b; }
    .status-returned { background-color: #f1f8e9; color: #689f38; }

    /* Responsive Design */
    @media (max-width: 992px) {
      .main-content {
        padding: 15px;
      }
      
      .stats-grid {
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      }
      
      .col-lg-8, .col-lg-4 {
        flex: 0 0 100%;
        max-width: 100%;
      }
      
      .top-lists-sidebar {
        margin-top: 2rem;
      }
      
      .top-lists-sidebar .row {
        display: flex;
        gap: 1rem;
      }
      
      .top-lists-sidebar .top-list-card {
        flex: 1;
        margin-bottom: 1rem;
      }
    }

    @media (max-width: 768px) {
      .admin-layout {
        flex-direction: column;
      }
      
      .main-content {
        padding: 10px;
      }

      .dashboard-title {
        font-size: 1.5rem;
      }

      .stat-card-value {
        font-size: 1.5rem;
      }

      .chart-container {
        height: 300px;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }
      
      .top-lists-sidebar .row {
        flex-direction: column;
      }
      
      .top-lists-sidebar .top-list-card {
        margin-bottom: 1rem;
      }
      
      .filter-buttons {
        justify-content: center;
      }
    }
  </style>
</head>

<body>
  <div class="admin-layout">
    <%- include('../partials/sidebar') %>

    <div class="main-content">
      <%- include('../partials/adminNavbar', { pageTitle: 'Dashboard' }) %>

      <div class="container-fluid py-3">
        <!-- Dashboard Header -->
        <div class="dashboard-header">
          <h1 class="dashboard-title">
            <i class="fas fa-chart-line me-2"></i>Dashboard Overview
          </h1>
          <p class="dashboard-subtitle">
            Monitor your business performance and key metrics
            <span class="text-muted ms-3">
              <i class="fas fa-clock me-1"></i>
              Last updated: <span id="last-updated">Loading...</span>
            </span>
          </p>
        </div>

        <!-- Stats Cards -->
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-card-header">
              <div class="stat-card-content">
                <div class="stat-card-title">Total Revenue</div>
                <div class="stat-card-value">Rs<span id="total-sales">0</span></div>
                <div class="stat-card-change">Completed payments only</div>
              </div>
              <div class="stat-card-icon sales">
                <i class="fas fa-rupee-sign"></i>
              </div>
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-card-header">
              <div class="stat-card-content">
                <div class="stat-card-title">Total Customers</div>
                <div class="stat-card-value"><span id="total-customers">0</span></div>
                <div class="stat-card-change">Registered users</div>
              </div>
              <div class="stat-card-icon customers">
                <i class="fas fa-users"></i>
              </div>
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-card-header">
              <div class="stat-card-content">
                <div class="stat-card-title">Total Orders</div>
                <div class="stat-card-value"><span id="total-orders">0</span></div>
                <div class="stat-card-change">Orders placed</div>
              </div>
              <div class="stat-card-icon orders">
                <i class="fas fa-shopping-cart"></i>
              </div>
            </div>
          </div>
        </div>

        <!-- Main Dashboard Content -->
        <div class="row">
          <!-- Left Side - Chart with Filters -->
          <div class="col-lg-8">
            <div class="chart-section">
              <div class="chart-header">
                <h2 class="chart-title">
                  <i class="fas fa-chart-area me-2"></i>Revenue Overview
                </h2>
                <small class="text-muted">Shows completed payments only (excludes pending COD orders)</small>
              </div>
              
              <!-- Filter Buttons -->
              <div class="filter-section mb-3">
                <div class="filter-buttons">
                  <button class="filter-btn" data-period="daily">
                    <i class="fas fa-calendar-day me-1"></i>Daily
                  </button>
                  <button class="filter-btn" data-period="weekly">
                    <i class="fas fa-calendar-week me-1"></i>Weekly
                  </button>
                  <button class="filter-btn active" data-period="monthly">
                    <i class="fas fa-calendar-alt me-1"></i>Monthly
                  </button>
                  <button class="filter-btn" data-period="yearly">
                    <i class="fas fa-calendar me-1"></i>Yearly
                  </button>
                </div>
              </div>
              
              <!-- Chart Container -->
              <div class="chart-container">
                <canvas id="main-sales-chart"></canvas>
              </div>
            </div>
          </div>

          <!-- Right Side - Top Lists -->
          <div class="col-lg-4">
            <div class="top-lists-sidebar">
              <div class="row d-lg-block">
                <!-- Best Selling Products -->
                <div class="col-md-4 col-lg-12">
                  <div class="top-list-card mb-3">
                    <h3 class="top-list-title">
                      <i class="fas fa-trophy text-warning me-2"></i>Best Selling Products
                    </h3>
                    <div id="top-products-list">
                      <!-- Products will be populated here -->
                    </div>
                  </div>
                </div>

                <!-- Best Selling Categories -->
                <div class="col-md-4 col-lg-12">
                  <div class="top-list-card mb-3">
                    <h3 class="top-list-title">
                      <i class="fas fa-tags text-info me-2"></i>Best Selling Categories
                    </h3>
                    <div id="top-categories-list">
                      <!-- Categories will be populated here -->
                    </div>
                  </div>
                </div>

                <!-- Best Selling Types -->
                <div class="col-md-4 col-lg-12">
                  <div class="top-list-card">
                    <h3 class="top-list-title">
                      <i class="fas fa-star text-success me-2"></i>Best Selling Types
                    </h3>
                    <div id="top-brands-list">
                      <!-- Product types will be populated here -->
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Recent Orders -->
        <div class="table-section">
          <h2 class="table-title">
            <i class="fas fa-clock me-2"></i>Recent Orders
          </h2>
          <div class="table-responsive">
            <table class="custom-table">
              <thead>
                <tr>
                  <th>Order ID</th>
                  <th>Customer</th>
                  <th>Date</th>
                  <th>Total</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="recent-orders-table">
                <!-- Orders will be populated here -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    function formatCurrency(num) {
      return new Intl.NumberFormat("en-IN", { style: "currency", currency: "INR" }).format(num);
    }

    function formatDate(dateStr) {
      const d = new Date(dateStr);
      return d.toLocaleDateString("en-IN");
    }

    async function fetchDashboard(period = "monthly") {
      const res = await fetch(`/admin/dashboard-details?timeFilter=${period}`);
      const result = await res.json();
      
      if (!res.ok) {
        throw new Error(result.message || 'Failed to fetch dashboard data');
      }
      
      return result.data || result; // Handle both new and old response formats
    }

    function populateRecentOrders(list) {
      const tbody = document.getElementById("recent-orders-table");
      tbody.innerHTML = "";

      if (list.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="5" class="text-center text-muted py-4">
              <i class="fas fa-inbox fa-2x mb-2 d-block"></i>
              No recent orders found
            </td>
          </tr>
        `;
        return;
      }

      list.forEach(order => {
        const status = order.status || 'PENDING';
        const statusClass = `status-${status.toLowerCase().replace('_', '-')}`;
        
        tbody.innerHTML += `
          <tr>
            <td><span class="order-id">${order.orderNumber || "N/A"}</span></td>
            <td>${order.user?.name || "Unknown"}</td>
            <td>${formatDate(order.createdAt)}</td>
            <td><strong>Rs${order.totalAmount.toLocaleString()}</strong></td>
            <td><span class="status-badge ${statusClass}">${status.replace('_', ' ')}</span></td>
          </tr>
        `;
      });
    }

    function populateTopLists(products, categories, brands) {
      const prod = document.getElementById("top-products-list");
      const cat = document.getElementById("top-categories-list");
      const br = document.getElementById("top-brands-list");

      prod.innerHTML = "";
      cat.innerHTML = "";
      br.innerHTML = "";

      // ------------------- TOP PRODUCTS -------------------
      if (products.length === 0) {
        prod.innerHTML = `
          <div class="text-center text-muted py-2">
            <i class="fas fa-box-open mb-1 d-block"></i>
            <small>No data available</small>
          </div>
        `;
      } else {
        products.slice(0, 5).forEach((p, index) => {
          prod.innerHTML += `
            <div class="top-list-item">
              <span class="top-list-name">
                <span class="badge bg-secondary me-2">${index + 1}</span>
                ${p.title || "Unnamed Product"}
              </span>
              <span class="top-list-count">${p.totalQty}</span>
            </div>
          `;
        });
      }

      // ------------------- TOP CATEGORIES -------------------
      if (categories.length === 0) {
        cat.innerHTML = `
          <div class="text-center text-muted py-2">
            <i class="fas fa-tags mb-1 d-block"></i>
            <small>No data available</small>
          </div>
        `;
      } else {
        categories.forEach((c, index) => {
          cat.innerHTML += `
            <div class="top-list-item">
              <span class="top-list-name">
                <span class="badge bg-secondary me-2">${index + 1}</span>
                ${c.name || "Unknown Category"}
              </span>
              <span class="top-list-count">${c.totalQty}</span>
            </div>
          `;
        });
      }

      // ------------------- TOP BRANDS -------------------
      if (brands.length === 0) {
        br.innerHTML = `
          <div class="text-center text-muted py-2">
            <i class="fas fa-star mb-1 d-block"></i>
            <small>No data available</small>
          </div>
        `;
      } else {
        brands.forEach((b, index) => {
          br.innerHTML += `
            <div class="top-list-item">
              <span class="top-list-name">
                <span class="badge bg-secondary me-2">${index + 1}</span>
                ${b.name || "Unknown Type"}
              </span>
              <span class="top-list-count">${b.totalQty}</span>
            </div>
          `;
        });
      }
    }

    let mainChart;

    function updateMainChart(labels, data) {
        if (mainChart) mainChart.destroy();

        const ctx = document.getElementById("main-sales-chart").getContext("2d");

        // Prevent negative Y-axis and handle empty data
        const maxValue = data.length > 0 ? Math.max(...data) : 0;
        const suggestedMax = maxValue === 0 ? 1000 : maxValue * 1.3;

        mainChart = new Chart(ctx, {
            type: "line",
            data: {
                labels,
                datasets: [{
                    label: "Revenue (Rs)",
                    data,
                    borderColor: "#343a40",
                    backgroundColor: "rgba(52, 58, 64, 0.1)",
                    tension: 0.4,
                    fill: true,
                    pointRadius: 5,
                    pointBackgroundColor: "#343a40",
                    pointBorderColor: "#fff",
                    pointBorderWidth: 2,
                    pointHoverRadius: 7,
                    borderWidth: 3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                
                scales: {
                    y: {
                        beginAtZero: true,
                        suggestedMin: 0,
                        suggestedMax: suggestedMax,
                        grid: {
                            color: "#f1f3f4",
                            borderDash: [5, 5]
                        },
                        ticks: {
                            callback: value => "Rs" + value.toLocaleString(),
                            color: "#6c757d",
                            font: {
                              size: 12
                            }
                        }
                    },
                    x: {
                        grid: { 
                          display: false 
                        },
                        ticks: {
                          autoSkip: false,
                          maxRotation: 45,
                          minRotation: 45,
                          color: "#6c757d",
                          font: {
                            size: 12
                          }
                        }
                    }
                },

                plugins: {
                    legend: { 
                      display: true,
                      position: 'top',
                      labels: {
                        color: "#495057",
                        font: {
                          size: 14,
                          weight: 500
                        },
                        usePointStyle: true,
                        padding: 20
                      }
                    },
                    tooltip: {
                      backgroundColor: "#343a40",
                      titleColor: "#fff",
                      bodyColor: "#fff",
                      borderColor: "#dee2e6",
                      borderWidth: 1,
                      cornerRadius: 8,
                      displayColors: false,
                      callbacks: {
                        label: function(context) {
                          return "Sales: Rs" + context.parsed.y.toLocaleString();
                        }
                      }
                    }
                },

                interaction: {
                  intersect: false,
                  mode: 'index'
                }
            }
        });
    }

    async function init(period = "monthly") {
      try {
        // Show loading states
        document.getElementById("total-sales").innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        document.getElementById("total-customers").innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        document.getElementById("total-orders").innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        
        // Show loading in tables and lists
        document.getElementById("recent-orders-table").innerHTML = `
          <tr>
            <td colspan="5" class="text-center py-4">
              <i class="fas fa-spinner fa-spin fa-2x mb-2 d-block"></i>
              Loading recent orders...
            </td>
          </tr>
        `;
        
        document.getElementById("top-products-list").innerHTML = `
          <div class="text-center text-muted py-2">
            <i class="fas fa-spinner fa-spin mb-1 d-block"></i>
            <small>Loading...</small>
          </div>
        `;
        
        document.getElementById("top-categories-list").innerHTML = `
          <div class="text-center text-muted py-2">
            <i class="fas fa-spinner fa-spin mb-1 d-block"></i>
            <small>Loading...</small>
          </div>
        `;
        
        document.getElementById("top-brands-list").innerHTML = `
          <div class="text-center text-muted py-2">
            <i class="fas fa-spinner fa-spin mb-1 d-block"></i>
            <small>Loading...</small>
          </div>
        `;

        const data = await fetchDashboard(period);

        // Update stats
        document.getElementById("total-sales").textContent = data.totalSales.toLocaleString("en-IN");
        document.getElementById("total-customers").textContent = data.customers;
        document.getElementById("total-orders").textContent = data.totalOrders;

        // Update chart
        updateMainChart(data.timeSeriesLabels, data.timeSeriesData);

        // Update tables and lists
        populateRecentOrders(data.recentOrders);
        populateTopLists(data.topProducts, data.topCategories, data.topBrands);

        // Update last updated time
        document.getElementById("last-updated").textContent = new Date().toLocaleString();
        
        // Update dashboard subtitle with current filter
        const filterText = period.charAt(0).toUpperCase() + period.slice(1);
        document.querySelector('.dashboard-subtitle').innerHTML = `
          Monitor your business performance and key metrics (${filterText} view)
          <span class="text-muted ms-3">
            <i class="fas fa-clock me-1"></i>
            Last updated: <span id="last-updated">${new Date().toLocaleString()}</span>
          </span>
        `;

      } catch (error) {
        console.error('Error loading dashboard data:', error);
        
        // Show error states
        document.getElementById("total-sales").textContent = "Error";
        document.getElementById("total-customers").textContent = "Error";
        document.getElementById("total-orders").textContent = "Error";
        
        // Show error message in recent orders table
        document.getElementById("recent-orders-table").innerHTML = `
          <tr>
            <td colspan="5" class="text-center text-danger py-4">
              <i class="fas fa-exclamation-triangle fa-2x mb-2 d-block"></i>
              Error loading dashboard data. Please refresh the page.
            </td>
          </tr>
        `;
      }
    }

    document.querySelectorAll(".filter-btn").forEach(btn => {
      btn.addEventListener("click", async () => {
        // Prevent multiple clicks
        if (btn.disabled) return;
        
        // Update active state
        document.querySelectorAll(".filter-btn").forEach(b => {
          b.classList.remove("active");
          b.disabled = false;
        });
        btn.classList.add("active");
        btn.disabled = true;
        
        // Show loading state
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>' + btn.textContent.trim();
        
        try {
          await init(btn.dataset.period);
        } finally {
          // Restore button state
          btn.innerHTML = originalText;
          btn.disabled = false;
        }
      });
    });

    init();
  </script>
</body>
</html>