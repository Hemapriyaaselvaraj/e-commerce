<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>All Collection | ToughToes</title>

  <!-- External libs you actually use -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />

  <!-- INTERNAL CSS -->
  <style>
    /* Global */
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: 'Inter', sans-serif;
      background: #fff;
      color: #111;
    }

    a {
      text-decoration: none;
      color: inherit;
    }

    /* Optional: if your included navbar uses these classes */
    .navbar {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      z-index: 1000;
      background: #fff;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 1.5rem;
      border-bottom: 1px solid #ddd;
    }

    .nav-links a {
      margin: 0 1rem;
      text-decoration: none;
      color: #000;
    }

    .nav-right {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-left: auto;
      margin-right: 1.5rem;
    }

    .search-input {
      padding: 0.5rem;
      border: 1px solid #000000;
      min-width: 180px;
    }

    .logo {
      margin-left: 0.5rem;
    }

    /* Main collection layout */
    .collection-container {
      max-width: 1490px;
      margin: 0 auto;
      padding: 6rem 2rem 2rem 2rem; /* extra top padding because of fixed navbar */
    }

    .breadcrumb {
      font-size: 0.85rem;
      color: gray;
      margin-bottom: 0.5rem;
    }

    .collection-container h1 {
      margin: 0.2rem 0;
      font-size: 1.8rem;
    }

    .collection-container > p {
      margin: 0 0 1rem 0;
      color: #444;
    }

    .collection-main {
      display: grid;
      grid-template-columns: 260px minmax(0, 1fr);
      gap: 2rem;
      margin-top: 1rem;
      align-items: flex-start;
    }

    /* Filters sidebar */
    .filters {
      border-right: 1px solid #eee;
      padding-right: 1rem;
      position: sticky;
      top: 5.5rem; /* below navbar */
      max-height: calc(100vh - 6rem);
      overflow-y: auto;
      background: #fff;
    }

    .filters form {
      width: 100%;
    }

    .filter-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.75rem;
    }

    .filter-header h3 {
      margin: 0;
      font-size: 1.1rem;
    }

    .clear-btn {
      background: none;
      border: none;
      color: #0077cc;
      cursor: pointer;
      font-size: 0.85rem;
    }

    .clear-btn:hover {
      text-decoration: underline;
    }

    .filter-group {
      margin-top: 1rem;
      padding-bottom: 0.75rem;
      border-bottom: 1px solid #f0f0f0;
    }

    .filter-group:last-of-type {
      border-bottom: none;
    }

    .filter-group p {
      font-weight: bold;
      margin: 0 0 0.3rem 0;
      font-size: 0.95rem;
    }

    .filter-group label {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
      cursor: pointer;
      font-size: 0.9rem;
    }

    .filter-group input[type="checkbox"],
    .filter-group input[type="radio"] {
      accent-color: #2d7cf7;
    }

    .search-bar {
      margin: 0 0 20px 0;
      position: relative;
    }

    .search-bar-inner {
      display: flex;
      width: 100%;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      border-radius: 4px;
      overflow: hidden;
    }

    .search-bar input[type="text"] {
      flex-grow: 1;
      padding: 12px 30px 12px 15px;
      border: 1px solid #e0e0e0;
      border-right: none;
      font-size: 14px;
      outline: none;
      transition: all 0.3s;
    }

    .search-bar input[type="text"]:focus {
      border-color: #2d7cf7;
      box-shadow: 0 0 0 1px rgba(45, 124, 247, 0.15);
    }

    .search-bar button[type="submit"] {
      padding: 0 12px;
      background: #2d7cf7;
      color: white;
      border: none;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color 0.3s;
    }

    .search-bar button[type="submit"]:hover {
      background-color: #1b6fe6;
    }

    .clear-search {
      position: absolute;
      right: 60px;
      top: 50%;
      transform: translateY(-50%);
      border: none;
      background: none;
      cursor: pointer;
      padding: 0;
      color: #999;
      font-size: 16px;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .apply-btn {
      margin-top: 16px;
      width: 100%;
      background: #2d7cf7;
      color: #fff;
      border: none;
      padding: 10px 0;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      font-size: 0.95rem;
      transition: background 0.25s, transform 0.1s;
    }

    .apply-btn:hover {
      background: #1b6fe6;
    }

    .apply-btn:active {
      transform: scale(0.98);
    }

    /* Products section */
    .products-section {
      width: 100%;
      min-width: 0;
    }

    .products-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .products-header p {
      margin: 0;
      font-size: 0.95rem;
      color: #333;
    }

    .products-header select {
      padding: 0.3rem 0.6rem;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 0.9rem;
      min-width: 180px;
    }

    .product-list-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 32px 24px;
    }

    /* When there are very few results (1 or 2), keep product cards a fixed width and center them
       so they don't stretch across the whole row. The `few-results` class is added server-side. */
    .product-list-container.few-results {
      display: flex;
      justify-content: center;
      gap: 32px 24px;
      flex-wrap: nowrap;
    }

    .product-list-container.few-results .product-card.enhanced-card {
      flex: 0 0 320px; /* fixed card width */
      max-width: 320px;
    }

    .product-card.enhanced-card {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 12px 0 rgba(0,0,0,0.06);
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      padding: 18px 16px 20px 16px;
      transition: box-shadow 0.2s, transform 0.15s;
      min-height: 340px;
      position: relative;
      width: 100%;
      box-sizing: border-box;
      cursor: pointer;
    }

    /* wishlist heart button */
    .wishlist-btn {
      position: absolute;
      top: 12px;
      right: 12px;
      background: rgba(255,255,255,0.95);
      border: 1px solid #eee;
      width: 38px;
      height: 38px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 5;
      box-shadow: 0 2px 6px rgba(0,0,0,0.06);
    }

    .wishlist-btn .fa-heart {
      font-size: 16px;
      color: #999;
      transition: color 0.15s ease-in-out, transform 0.12s;
    }

    .wishlist-btn.active .fa-heart {
      color: #e63946;
      transform: scale(1.05);
    }

    /* Offer badge - Circular scalloped design */
    .offer-badge {
      position: absolute;
      top: 8px;
      left: 8px;
      width: 50px;
      height: 50px;
      background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 16px;
      font-weight: 800;
      z-index: 5;
      box-shadow: 0 3px 10px rgba(255, 107, 53, 0.4);
      animation: pulse 2s infinite;
    }

    .offer-badge::before {
      content: '';
      position: absolute;
      width: 100%;
      height: 100%;
      background: inherit;
      border-radius: 50%;
      clip-path: polygon(
        50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%
      );
      z-index: -1;
    }

    @keyframes pulse {
      0%, 100% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.05);
      }
    }

    .product-card.enhanced-card:hover {
      box-shadow: 0 4px 24px 0 rgba(0,0,0,0.12);
      transform: translateY(-2px);
    }

    .product-image-wrapper {
      width: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 140px;
      margin-bottom: 18px;
    }

    .product-img-enhanced {
      max-width: 96%;
      max-height: 220px;
      min-height: 180px;
      object-fit: contain;
      border-radius: 8px;
      background: #f7f7f7;
    }

    .product-info-enhanced {
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .product-title {
      font-size: 1.01rem;
      font-weight: 500;
      color: #222;
      margin-bottom: 2px;
    }

    .product-meta {
      font-size: 0.97rem;
      color: #666;
      margin-bottom: 6px;
    }

    .product-price-row {
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
      margin-top: 4px;
    }

    .product-price {
      font-size: 1.08rem;
      color: #222;
      font-weight: 700;
    }

    .product-original-price {
      font-size: 0.98rem;
      color: #888;
      text-decoration: line-through;
    }

    .product-discount {
      font-size: 0.97rem;
      color: #cd4e4b;
      font-weight: 600;
    }

    /* Pagination */
    .pagination {
      display: flex;
      justify-content: center;
      margin-top: 2rem;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .page-btn {
      padding: 0.4rem 0.8rem;
      border: 1px solid #ccc;
      background: white;
      cursor: pointer;
      border-radius: 4px;
      font-size: 0.9rem;
      min-width: 32px;
    }

    .page-btn.active {
      background: black;
      color: white;
      border-color: black;
    }

    .page-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Footer (basic internal styling in case your partial uses these) */
    .footer {
      background: #111;
      color: #eee;
      padding: 2rem;
      margin-top: 4rem;
    }

    .footer-grid {
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 2rem;
    }

    .footer-grid ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .footer-grid a {
      color: #ccc;
      text-decoration: none;
      font-size: 0.9rem;
    }

    .footer-grid a:hover {
      text-decoration: underline;
    }

    footer p {
      margin-top: 1rem;
      text-align: center;
      font-size: 0.9rem;
      color: #aaa;
    }

    /* Responsiveness */

    /* Medium screens: sidebar shrinks */
    @media (max-width: 1100px) {
      .collection-main {
        grid-template-columns: 220px minmax(0, 1fr);
      }
    }

    /* Tablet: filters and products stack; filters become a top block */
    @media (max-width: 900px) {
      .collection-container {
        padding: 5rem 1.25rem 1.5rem 1.25rem;
      }

      .collection-main {
        grid-template-columns: 1fr;
      }

      .filters {
        position: static;
        max-height: none;
        border-right: none;
        border-bottom: 1px solid #eee;
        padding-right: 0;
        padding-bottom: 1rem;
      }

      .products-header {
        align-items: flex-start;
      }

      .product-list-container {
        gap: 24px 16px;
      }
    }

    /* Mobile: single column cards, full-width buttons */
    @media (max-width: 600px) {
      .collection-container {
        padding: 4.5rem 1rem 1.5rem 1rem;
      }

      .products-header {
        flex-direction: column;
        align-items: flex-start;
      }

      .products-header select {
        width: 100%;
      }

      .product-card.enhanced-card {
        min-height: 320px;
        padding: 16px 12px 18px 12px;
      }

      .product-img-enhanced {
        min-height: 160px;
      }

      .search-bar-inner {
        flex-wrap: nowrap;
      }

      .clear-search {
        right: 52px;
      }
    }
  </style>
</head>
<body>

<%- include('../partials/userNavbar') %>

  <div class="collection-container">
    <div class="breadcrumb">Home / All Collection</div>
    <h1>All Collection</h1>
    <p>Discover our premium collection of footwear</p>

    <div class="collection-main">
      <!-- Filters -->
      <aside class="filters">
        <form id="filterForm" method="get" action="" autocomplete="off">

          <div class="filter-header">
            <h3>Filters</h3>
            <button type="button" class="clear-btn" onclick="clearAllFilters()">Clear All</button>
          </div>

          <div class="filter-group">
            <p>Category</p>
            <% categories.forEach(category => { %>
              <label>
                <input 
                  type="radio" 
                  name="category" 
                  value="<%= category.category %>" 
                  <%= selectedCategory === category.category ? 'checked' : '' %> 
                />
                <span><%= category.category %></span>
              </label>
            <% }) %>
          </div>

          <div class="filter-group">
            <p>Shoe Type</p>
            <% types.forEach(type => { %>
              <label>
                <input 
                  type="checkbox" 
                  name="type" 
                  value="<%= type.type %>" 
                  <%= selectedType && selectedType.includes(type.type) ? 'checked' : '' %> 
                />
                <span><%= type.type %></span>
              </label>
            <% }) %>
          </div>

          <div class="filter-group">
            <p>Size</p>
            <% sizes.forEach(size => { %>
              <label>
                <input 
                  type="checkbox" 
                  name="size" 
                  value="<%= String(size.size) %>" 
                  <%= selectedSize && selectedSize.includes(String(size.size)) ? 'checked' : '' %> 
                />
                <span><%= size.size %></span>
              </label>
            <% }) %>
          </div>

          <div class="filter-group">
            <p>Color</p>
            <% colors.forEach(color => { %>
              <label>
                <input 
                  type="checkbox" 
                  name="color" 
                  value="<%= color.color %>" 
                  <%= selectedColor && selectedColor.includes(color.color) ? 'checked' : '' %> 
                />
                <span><%= color.color %></span>
              </label>
            <% }) %>
          </div>

          <div class="filter-group">
            <p>Price Range</p>
            <% priceRanges.forEach(range => { %>
              <label>
                <input 
                  type="checkbox" 
                  name="price" 
                  value="<%= range.min %>-<%= range.max %>" 
                  <%= selectedPrice && selectedPrice.includes(String(range.min) + '-' + String(range.max)) ? 'checked' : '' %> 
                />
                <span><%= range.label %></span>
              </label>
            <% }) %>
          </div>

          <button type="submit" class="apply-btn">Apply</button>
        </form>
      </aside>

      <!-- Products -->
      <section class="products-section">
        <div class="products-header">
          <p>
            Showing 
            <%= (totalResults === 0 ? 0 : ((currentPage - 1) * 20 + 1)) %> 
            to 
            <%= Math.min(currentPage * 20, totalResults) %> 
            of 
            <%= totalResults %> 
            products
          </p>

          <form id="sortForm" method="get" style="margin:0;">
            <select name="sort" onchange="this.form.submit()">
              <option value="asc" <%= sort === 'asc' ? 'selected' : '' %>>Price: Low to High</option>
              <option value="desc" <%= sort === 'desc' ? 'selected' : '' %>>Price: High to Low</option>
              <option value="nameAsc" <%= sort === 'nameAsc' ? 'selected' : '' %>>Name: A to Z</option>
              <option value="nameDesc" <%= sort === 'nameDesc' ? 'selected' : '' %>>Name: Z to A</option>
            </select>

            <% Object.keys(query || {}).forEach(function(key) { if(key !== 'sort' && key !== 'page') { %>
              <% if(Array.isArray(query[key])) { query[key].forEach(function(val){ %>
                <input type="hidden" name="<%= key %>[]" value="<%= val %>">
              <% }) } else { %>
                <input type="hidden" name="<%= key %>" value="<%= query[key] %>">
              <% } %>
            <% } }) %>
          </form>
        </div>

  <div class="product-list-container <%= products && products.length && products.length <= 2 ? 'few-results' : '' %>">
          <% if (products && products.length) { %>
            <% products.forEach(product => { %>
              <div 
                class="product-card enhanced-card"
                onclick="window.location.href='/products/<%= product._id %>'"
              >
                <!-- Offer badge - Show only if there's an admin offer -->
                <% if (product.offerDiscount && product.offerDiscount > 0) { %>
                  <div class="offer-badge">
                    <%= Math.round(product.offerDiscount) %>%
                  </div>
                <% } %>

                <!-- Wishlist button -->
                <button
                  type="button"
                  class="wishlist-btn <%= wishlistMap && wishlistMap[product._id] ? 'active' : '' %>"
                  onclick="event.stopPropagation(); toggleWishlist(event, '<%= product._id %>')"
                  aria-label="Add to wishlist"
                >
                  <i class="<%= wishlistMap && wishlistMap[product._id] ? 'fas' : 'far' %> fa-heart"></i>
                </button>
                <div class="product-image-wrapper">
                  <% if (product.image) { %>
                    <img 
                      src="<%= product.image %>" 
                      alt="<%= product.name %>" 
                      class="product-img-enhanced"
                    >
                  <% } else { %>
                    <img 
                      src="https://via.placeholder.com/200x150?text=<%= encodeURIComponent(product.name) %>" 
                      alt="<%= product.name %>" 
                      class="product-img-enhanced"
                    >
                  <% } %>
                </div>

                <div class="product-info-enhanced">
                  <div class="product-title"><%= product.name %></div>
                  <div class="product-meta"><%= product.product_type %></div>

                  <div class="product-price-row">
                    <span class="product-price">
                      â‚¹ <%= product.price.toLocaleString() %>
                    </span>
                  </div>
                </div>
              </div>
            <% }) %>
          <% } else { %>
            <div>No products available.</div>
          <% } %>
        </div>

        <div class="pagination">
          <button 
            class="page-btn" 
            <%= currentPage === 1 ? 'disabled' : '' %> 
            onclick="goToPage(<%= currentPage - 1 %>)"
          >Previous</button>

          <% for(let i = 1; i <= totalPages; i++) { %>
            <button 
              class="page-btn <%= currentPage === i ? 'active' : '' %>" 
              <%= currentPage === i ? 'disabled' : '' %> 
              onclick="goToPage(<%= i %>)"
            ><%= i %></button>
          <% } %>

          <button 
            class="page-btn" 
            <%= currentPage === totalPages || totalPages === 0 ? 'disabled' : '' %> 
            onclick="goToPage(<%= currentPage + 1 %>)"
          >Next</button>
        </div>
      </section>
    </div>
  </div>

  <%- include('../partials/footer') %>

  <!-- JS helpers -->
  <script>
    // Clear search by removing the search param from the URL and reloading
    function clearSearch() {
      const params = new URLSearchParams(window.location.search);
      params.delete('search');
      const qs = params.toString();
      window.location.href = window.location.pathname + (qs ? ('?' + qs) : '');
    }

    function clearAllFilters() {
      window.location = window.location.pathname;
    }

    function selectCategory(category) {
      const params = new URLSearchParams(window.location.search);
      params.set('category', category);
      params.delete('page');
      window.location.search = params.toString();
    }

    function goToPage(page) {
      const params = new URLSearchParams(window.location.search);
      params.set('page', page);
      window.location.search = params.toString();
    }
  </script>

  <script>
    async function toggleWishlist(event, productId) {
      const btn = event.currentTarget;
      try {
        const res = await fetch('/wishlist/toggle', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ productId }),
        });

        if (res.status === 401) {
          // not logged in
          window.location.href = '/user/login';
          return;
        }

        const data = await res.json();
        if (!data || !data.success) {
          alert(data.message || 'Could not update wishlist');
          return;
        }

        const icon = btn.querySelector('i');
        if (data.action === 'added') {
          btn.classList.add('active');
          if (icon) { icon.classList.remove('far'); icon.classList.add('fas'); }
        } else {
          btn.classList.remove('active');
          if (icon) { icon.classList.remove('fas'); icon.classList.add('far'); }
        }
        
        // Update navbar wishlist count
        if (window.updateNavbarCounts) {
          window.updateNavbarCounts();
        }
      } catch (err) {
        console.error('Wishlist toggle failed', err);
        alert('Network error. Please try again.');
      }
    }
  </script>
</body>
</html>