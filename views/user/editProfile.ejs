<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Edit Profile - ToughToes</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    /* Navbar styles - matching profile page */
    .btn-login {
      background: #007bff;
      color: #fff;
      border: none;
      border-radius: 4px;
      padding: 0.4rem 1.1rem;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
      margin-left: 0.5rem;
    }
    .btn-login:hover {
      background: #0056b3;
    }

    /* Navbar */
    .navbar {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      z-index: 1000;
      background: #fff;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 1.5rem;
      border-bottom: 1px solid #ddd;
    }
    .nav-links a {
      margin: 0 1rem;
      text-decoration: none;
      color: #000;
    }
    .nav-right {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-left: auto;
      margin-right: 1.5rem;
    }
    .search-input {
      padding: 0.5rem;
      border: 1px solid #ccc;
      min-width: 180px;
    }
    .logo {
      margin-left: 0.5rem;
    }

    /* Body spacing for fixed navbar */
    body {
      padding-top: 90px;
    }

    /* Form styling */
    .edit-profile-card {
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      border: 1px solid #e9ecef;
    }
    
    .form-control:focus {
      border-color: #000;
      box-shadow: 0 0 0 0.2rem rgba(0, 0, 0, 0.25);
    }
    
    .btn-dark {
      background-color: #000;
      border-color: #000;
    }
    
    .btn-dark:hover {
      background-color: #333;
      border-color: #333;
    }
    
    /* Validation styling */
    .form-control.is-invalid {
      border-color: #dc3545;
      box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
    }
    
    .form-control.is-valid {
      border-color: #28a745;
      box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
    }
    
    .invalid-feedback {
      display: none;
      width: 100%;
      margin-top: 0.25rem;
      font-size: 0.875em;
      color: #dc3545;
    }
    
    .form-text {
      margin-top: 0.25rem;
      font-size: 0.875em;
      color: #6c757d;
    }
    
    .text-danger {
      color: #dc3545 !important;
    }
  </style>
</head>
<body>
  <%- include('../partials/userNavbar', { 
    name: name, 
    cartCount: cartCount, 
    wishlistCount: wishlistCount 
  }) %>

  <div class="container my-5 d-flex justify-content-center">
    <div class="edit-profile-card p-4" style="max-width: 500px; width: 100%;">
      <h4 class="mb-3">Edit Profile</h4>
      <form id="editProfileForm">
        <div class="mb-3">
          <label for="firstName" class="form-label">First Name <span class="text-danger">*</span></label>
          <input type="text" class="form-control" id="firstName" name="firstName" value="<%= user.firstName %>" required>
          <div class="invalid-feedback" id="firstNameError"></div>
          <div class="form-text">2-50 characters, letters only</div>
        </div>
        <div class="mb-3">
          <label for="lastName" class="form-label">Last Name <span class="text-danger">*</span></label>
          <input type="text" class="form-control" id="lastName" name="lastName" value="<%= user.lastName %>" required>
          <div class="invalid-feedback" id="lastNameError"></div>
          <div class="form-text">1-50 characters, letters only</div>
        </div>
        <div class="mb-3">
          <label for="phoneNumber" class="form-label">Phone Number <span class="text-danger">*</span></label>
          <input type="text" class="form-control" id="phoneNumber" name="phoneNumber" value="<%= user.phoneNumber %>" required maxlength="10">
          <div class="invalid-feedback" id="phoneNumberError"></div>
          <div class="form-text">10-digit Indian mobile number (starts with 6-9)</div>
        </div>
        <div class="mb-3">
          <label for="email" class="form-label">Email</label>
          <div class="input-group mb-2">
            <input type="email" class="form-control" id="emailInput" name="email" value="<%= user.email %>" readonly>
            <button type="button" class="btn btn-outline-secondary" id="editEmailBtn">Edit</button>
          </div>
          <div id="newEmailGroup" style="display:none;">
            <input type="email" class="form-control mb-2" id="newEmailInput" placeholder="Enter new email address">
            <button type="button" class="btn btn-primary w-100 mb-2" id="sendOtpBtn">Send OTP</button>
            <div id="newEmailError" class="text-danger"></div>
          </div>
        </div>
        <button type="submit" class="btn btn-dark w-100">Save Changes</button>
        <a href="/profile" class="btn btn-link w-100 mt-2">Cancel</a>
      </form>
    </div>
  </div>

  <%- include('../partials/footer') %>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Validation functions
    function validateFirstName(firstName) {
      const errors = [];
      const trimmed = firstName.trim();
      
      if (!trimmed) {
        errors.push('First name is required');
      } else if (trimmed.length < 2) {
        errors.push('First name must be at least 2 characters long');
      } else if (trimmed.length > 50) {
        errors.push('First name cannot exceed 50 characters');
      } else if (!/^[a-zA-Z\s]+$/.test(trimmed)) {
        errors.push('First name can only contain letters and spaces');
      }
      
      return errors;
    }
    
    function validateLastName(lastName) {
      const errors = [];
      const trimmed = lastName.trim();
      
      if (!trimmed) {
        errors.push('Last name is required');
      } else if (trimmed.length > 50) {
        errors.push('Last name cannot exceed 50 characters');
      } else if (!/^[a-zA-Z\s]+$/.test(trimmed)) {
        errors.push('Last name can only contain letters and spaces');
      }
      
      return errors;
    }
    
    function validatePhoneNumber(phoneNumber) {
      const errors = [];
      const trimmed = phoneNumber.trim();
      const cleanPhone = trimmed.replace(/\D/g, ''); // Remove non-digits
      
      if (!trimmed) {
        errors.push('Phone number is required');
      } else if (cleanPhone.length !== 10) {
        errors.push('Phone number must be exactly 10 digits');
      } else if (!/^[6-9]/.test(cleanPhone)) {
        errors.push('Phone number must start with 6, 7, 8, or 9');
      } else if (!/^[6-9][0-9]{9}$/.test(cleanPhone)) {
        errors.push('Please enter a valid Indian mobile number');
      }
      
      return errors;
    }
    
    function showFieldError(fieldId, errors) {
      const field = document.getElementById(fieldId);
      const errorDiv = document.getElementById(fieldId + 'Error');
      
      if (errors.length > 0) {
        field.classList.add('is-invalid');
        field.classList.remove('is-valid');
        errorDiv.textContent = errors[0];
        errorDiv.style.display = 'block';
      } else {
        field.classList.remove('is-invalid');
        field.classList.add('is-valid');
        errorDiv.textContent = '';
        errorDiv.style.display = 'none';
      }
    }
    
    function clearFieldError(fieldId) {
      const field = document.getElementById(fieldId);
      const errorDiv = document.getElementById(fieldId + 'Error');
      
      field.classList.remove('is-invalid', 'is-valid');
      errorDiv.textContent = '';
      errorDiv.style.display = 'none';
    }
    
    // Real-time validation
    document.getElementById('firstName').addEventListener('input', function() {
      const errors = validateFirstName(this.value);
      showFieldError('firstName', errors);
    });
    
    document.getElementById('firstName').addEventListener('blur', function() {
      const errors = validateFirstName(this.value);
      showFieldError('firstName', errors);
    });
    
    document.getElementById('lastName').addEventListener('input', function() {
      const errors = validateLastName(this.value);
      showFieldError('lastName', errors);
    });
    
    document.getElementById('lastName').addEventListener('blur', function() {
      const errors = validateLastName(this.value);
      showFieldError('lastName', errors);
    });
    
    document.getElementById('phoneNumber').addEventListener('input', function() {
      // Allow only digits and limit to 10 characters
      this.value = this.value.replace(/\D/g, '').substring(0, 10);
      const errors = validatePhoneNumber(this.value);
      showFieldError('phoneNumber', errors);
    });
    
    document.getElementById('phoneNumber').addEventListener('blur', function() {
      const errors = validatePhoneNumber(this.value);
      showFieldError('phoneNumber', errors);
    });

    // Email functionality
    const emailInput = document.getElementById('emailInput');
    const editEmailBtn = document.getElementById('editEmailBtn');
    const newEmailGroup = document.getElementById('newEmailGroup');
    const newEmailInput = document.getElementById('newEmailInput');
    const sendOtpBtn = document.getElementById('sendOtpBtn');
    const newEmailError = document.getElementById('newEmailError');
    let originalEmail = emailInput.value;

    editEmailBtn.onclick = function() {
      newEmailGroup.style.display = '';
      newEmailInput.value = '';
      newEmailError.textContent = '';
      newEmailInput.focus();
      editEmailBtn.style.display = 'none';
    };

    sendOtpBtn.onclick = function() {
      const newEmail = newEmailInput.value.trim();
      if (!newEmail || newEmail === originalEmail) {
        newEmailError.textContent = 'Please enter a different email address.';
        return;
      }
      
      // Validate email format
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(newEmail)) {
        newEmailError.textContent = 'Please enter a valid email address.';
        return;
      }
      
      newEmailError.textContent = '';
      sendOtpBtn.disabled = true;
      sendOtpBtn.textContent = 'Sending...';
      
      fetch('/user/request-email-otp', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ newEmail })
      })
      .then(res => res.json())
      .then(data => {
        sendOtpBtn.disabled = false;
        sendOtpBtn.textContent = 'Send OTP';
        if (data.success) {
          // Redirect to the existing OTP verification page
          window.location.href = `/user/verifyOtp?email=${encodeURIComponent(newEmail)}&flow=email-change`;
        } else {
          newEmailError.textContent = data.message || 'Could not send OTP.';
        }
      })
      .catch(() => {
        sendOtpBtn.disabled = false;
        sendOtpBtn.textContent = 'Send OTP';
        newEmailError.textContent = 'Could not send OTP.';
      });
    };

    // Handle profile form submission with comprehensive validation
    document.getElementById('editProfileForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const firstName = document.getElementById('firstName').value;
      const lastName = document.getElementById('lastName').value;
      const phoneNumber = document.getElementById('phoneNumber').value;
      
      // Validate all fields
      const firstNameErrors = validateFirstName(firstName);
      const lastNameErrors = validateLastName(lastName);
      const phoneNumberErrors = validatePhoneNumber(phoneNumber);
      
      // Show validation errors
      showFieldError('firstName', firstNameErrors);
      showFieldError('lastName', lastNameErrors);
      showFieldError('phoneNumber', phoneNumberErrors);
      
      // Check if there are any errors
      if (firstNameErrors.length > 0 || lastNameErrors.length > 0 || phoneNumberErrors.length > 0) {
        Swal.fire({
          icon: 'error',
          title: 'Validation Error',
          text: 'Please fix the errors in the form before submitting.',
          confirmButtonColor: '#d33'
        });
        return;
      }
      
      const submitBtn = this.querySelector('button[type="submit"]');
      const originalText = submitBtn.textContent;
      
      submitBtn.disabled = true;
      submitBtn.textContent = 'Updating...';
      
      fetch('/profile/edit', {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          firstName: firstName.trim(),
          lastName: lastName.trim(),
          phoneNumber: phoneNumber.trim()
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          Swal.fire({
            icon: 'success',
            title: 'Success!',
            text: 'Profile updated successfully!',
            showConfirmButton: false,
            timer: 2000
          }).then(() => {
            window.location.href = '/profile';
          });
        } else {
          throw new Error(data.message || 'Update failed');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        Swal.fire({
          icon: 'error',
          title: 'Update Failed',
          text: error.message || 'Failed to update profile. Please try again.',
          confirmButtonColor: '#d33'
        });
      })
      .finally(() => {
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
      });
    });
    
    // Handle form submission for non-AJAX fallback
    document.querySelector('form[method="POST"]').addEventListener('submit', function() {
      emailInput.setAttribute('name', 'email');
      if (newEmailInput) newEmailInput.removeAttribute('name');
    });
  </script>
</body>
</html>
