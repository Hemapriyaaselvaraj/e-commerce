<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Order Details - ToughToes</title>

  <!-- External libs (keep) -->
  <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />

  <!-- Internal CSS - Light Theme to match other pages -->
  <style>
    /* General Layout */
    body {
      margin: 0;
      background-color: #f4f5f7;
      color: #0f172a;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding-top: 0;
    }

    /* Navbar alignment */
    .navbar {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      z-index: 1000;
      background: #fff;
      border-bottom: 1px solid #e4e7ec;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 1.5rem;
    }

    .nav-links a {
      margin: 0 1rem;
      text-decoration: none;
      color: #0f172a;
      transition: color 0.3s;
    }

    .nav-links a:hover {
      color: #6b7280;
    }

    .nav-right {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-left: auto;
      margin-right: 1.5rem;
    }

    .search-input {
      padding: 0.5rem;
      border: 1px solid #d1d5db;
      background: #fff;
      color: #0f172a;
      min-width: 180px;
      border-radius: 8px;
    }

    .search-input::placeholder {
      color: #9ca3af;
    }

    /* Container and Cards */
    .container {
      background-color: #f4f5f7;
    }

    .card {
      background-color: #fff;
      border: 1px solid #e4e7ec;
      border-radius: 18px;
      color: #0f172a;
      box-shadow: 0 20px 40px rgba(15, 23, 42, 0.08);
    }

    .card-header {
      background-color: #fff;
      color: #0f172a;
      border-bottom: 1px solid #e4e7ec;
      border-radius: 18px 18px 0 0;
      padding: 1.5rem 2rem;
      font-weight: 600;
    }

    .card-body {
      background-color: #fff;
      color: #0f172a;
      padding: 2rem;
    }

    /* Headers */
    h2, h4, h5, h6 {
      color: #0f172a;
      font-weight: 600;
    }

    /* Text Colors */
    p, small {
      color: #475467;
    }

    .text-muted {
      color: #6b7280 !important;
    }

    /* Table Styling */
    .table {
      background-color: #fff;
      color: #0f172a;
      border: 1px solid #e4e7ec;
      border-radius: 12px;
      overflow: hidden;
    }

    .table th {
      background-color: #f8fafc;
      color: #0f172a;
      border-color: #e4e7ec;
      font-weight: 600;
      padding: 1rem;
    }

    .table td {
      background-color: #fff;
      color: #0f172a;
      border-color: #f1f5f9;
      padding: 1rem;
    }

    .table-secondary {
      background-color: #f8fafc !important;
      color: #6b7280 !important;
    }

    .table-success {
      background-color: #fff !important;
      border-top: 2px solid #e4e7ec !important;
    }

    .table-light {
      background-color: #f8fafc !important;
      border-top: 2px solid #e4e7ec !important;
    }

    .table tbody tr:hover {
      background-color: #f8fafc;
    }

    /* Buttons */
    .btn-outline-secondary {
      border: 2px solid rgba(102, 126, 234, 0.3);
      color: #667eea;
      background: rgba(102, 126, 234, 0.05);
      border-radius: 12px;
      padding: 0.5rem 1rem;
      font-weight: 600;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .btn-outline-secondary::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s;
    }

    .btn-outline-secondary:hover::before {
      left: 100%;
    }

    .btn-outline-secondary:hover {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border-color: #667eea;
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
    }

    .btn-danger {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border: none;
      border-radius: 12px;
      padding: 0.5rem 1rem;
      font-weight: 600;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .btn-danger::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s;
    }

    .btn-danger:hover::before {
      left: 100%;
    }

    .btn-danger:hover {
      background: linear-gradient(135deg, #764ba2, #667eea);
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(118, 75, 162, 0.4);
    }

    .btn-warning {
      background: linear-gradient(135deg, #764ba2, #667eea);
      color: white;
      border: none;
      border-radius: 12px;
      padding: 0.5rem 1rem;
      font-weight: 600;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .btn-warning::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s;
    }

    .btn-warning:hover::before {
      left: 100%;
    }

    .btn-warning:hover {
      background: linear-gradient(135deg, #667eea, #764ba2);
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
    }

    .btn-outline-dark {
      border: 2px solid rgba(102, 126, 234, 0.3);
      color: #667eea;
      background: rgba(102, 126, 234, 0.05);
      border-radius: 12px;
      padding: 0.5rem 1rem;
      font-weight: 600;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .btn-outline-dark::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s;
    }

    .btn-outline-dark:hover::before {
      left: 100%;
    }

    .btn-outline-dark:hover {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border-color: #667eea;
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
    }

    /* Small button variants */
    .btn-sm {
      padding: 0.375rem 0.75rem;
      font-size: 0.875rem;
      border-radius: 8px;
    }

    /* Button hover effects for all buttons */
    .btn {
      position: relative;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s;
    }

    .btn:hover::before {
      left: 100%;
    }

    .btn:hover {
      transform: translateY(-2px);
    }

    /* Badges */
    .badge {
      border-radius: 8px;
      padding: 0.35em 0.65em;
      font-weight: 500;
    }

    .bg-success {
      background-color: #10b981 !important;
      color: #fff !important;
    }

    .bg-danger {
      background-color: #ef4444 !important;
      color: #fff !important;
    }

    .bg-primary {
      background-color: #3b82f6 !important;
      color: #fff !important;
    }

    .bg-warning {
      background-color: #f59e0b !important;
      color: #fff !important;
    }

    .bg-info {
      background-color: #06b6d4 !important;
      color: #fff !important;
    }

    .bg-secondary {
      background-color: #6b7280 !important;
      color: #fff !important;
    }

    /* Savings Section */
    .savings-section {
      background-color: #f0fdf4 !important;
      border: 1px solid #bbf7d0 !important;
      color: #0f172a !important;
      border-radius: 12px;
    }

    /* Images */
    img {
      border: 1px solid #e4e7ec;
      border-radius: 8px;
    }

    /* Utility Classes */
    .opacity-50 {
      opacity: 0.5;
    }

    /* Strikethrough text */
    s {
      color: #9ca3af;
    }

    /* Text Colors for different states */
    .text-success {
      color: #10b981 !important;
    }

    .text-danger {
      color: #ef4444 !important;
    }

    .text-primary {
      color: #3b82f6 !important;
    }

    .text-warning {
      color: #f59e0b !important;
    }

    /* Mobile Responsive */
    @media (max-width: 768px) {
      body {
        padding-top: 80px;
      }

      .navbar {
        padding: 0.75rem 1rem;
      }

      .card-header, .card-body {
        padding: 1rem;
      }

      .table thead {
        display: none;
      }

      .table, .table tbody, .table tr, .table td {
        display: block;
        width: 100%;
      }

      .table tr {
        margin-bottom: 1rem;
        border: 1px solid #e4e7ec;
        border-radius: 12px;
        background-color: #fff;
      }

      .table td {
        text-align: right;
        padding-left: 50%;
        position: relative;
        background-color: #fff !important;
        color: #0f172a !important;
        border: none;
        padding: 0.75rem;
      }

      .table td::before {
        content: attr(data-label);
        position: absolute;
        left: 0;
        width: 50%;
        padding-left: 15px;
        font-weight: bold;
        text-align: left;
        color: #0f172a;
      }
    }

    /* Footer */
    .footer {
      background-color: #1a1a1a;
      color: #fff;
      border-top: none;
    }

    /* Links */
    a {
      color: #3b82f6;
    }

    a:hover {
      color: #2563eb;
    }

    /* Form elements */
    .form-control, .form-select {
      background-color: #fff;
      color: #0f172a;
      border: 1px solid #d1d5db;
      border-radius: 8px;
    }

    .form-control:focus, .form-select:focus {
      background-color: #fff;
      color: #0f172a;
      border-color: #3b82f6;
      box-shadow: 0 0 0 0.2rem rgba(59, 130, 246, 0.25);
    }

    /* Modal styling */
    .modal-content {
      background-color: #fff;
      color: #0f172a;
      border: 1px solid #e4e7ec;
      border-radius: 18px;
    }

    .modal-header {
      background-color: #f8fafc;
      color: #0f172a;
      border-bottom: 1px solid #e4e7ec;
      border-radius: 18px 18px 0 0;
    }

    .modal-footer {
      border-top: 1px solid #e4e7ec;
    }

    /* SweetAlert2 custom styling */
    .swal2-popup {
      background-color: #fff !important;
      color: #0f172a !important;
      border: 1px solid #e4e7ec !important;
      border-radius: 18px !important;
    }

    .swal2-title {
      color: #0f172a !important;
    }

    .swal2-content {
      color: #475467 !important;
    }

    .swal2-input, .swal2-textarea, .swal2-select {
      background-color: #fff !important;
      color: #0f172a !important;
      border: 1px solid #d1d5db !important;
      border-radius: 8px !important;
    }

    /* Enhanced styling for better visual hierarchy */
    .card-header h4 {
      margin: 0;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .order-info-section {
      background-color: #f8fafc;
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .order-info-section h5 {
      color: #0f172a;
      margin-bottom: 1rem;
      font-weight: 600;
    }

    .order-info-section p {
      margin-bottom: 0.5rem;
      color: #475467;
    }

    .order-info-section strong {
      color: #0f172a;
    }
  </style>
</head>
<body>
  <%- include('../partials/userNavbar') %>

<div class="container" style="margin-top: 90px; margin-bottom: 3rem;">
    <div class="row">
      <div class="col-12">
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
              <a href="/order/my-orders" class="btn btn-outline-secondary btn-sm me-3">
                <i class="fas fa-arrow-left me-1"></i> Back to Orders
              </a>
              <h4 class="mb-0">Order #<%= order.orderNumber %></h4>
            </div>
            <div>
              <span class="badge bg-<%= order.status === 'DELIVERED' ? 'success' : (order.status === 'CANCELLED' ? 'danger' : 'primary') %>">
                <%= order.status %>
              </span>
              <% if (order.status === 'ORDERED') { %>
                <button class="btn btn-danger btn-sm ms-2" onclick="cancelOrder('<%= order._id %>')">
                  <i class="fas fa-times me-1"></i> Cancel Order
                </button>
              <% } %>
              <% if (order.status !== 'CANCELLED') { %>
                <a href="/order/download-invoice/<%= order._id %>" class="btn btn-outline-dark btn-sm ms-2" target="_blank">
                  <i class="fas fa-download me-1"></i> Download Invoice
                </a>
              <% } %>
            </div>
          </div>
          <div class="card-body">
            
            <div class="row mb-4">
              <div class="col-md-6">
                <div class="order-info-section">
                  <h5>Order Information</h5>
                  <p><strong>Order Date:</strong> <%= formatDate(order.createdAt) %></p>
                  <p><strong>Payment Method:</strong> <%= order.paymentMethod %></p>
                  <p><strong>Payment Status:</strong> <%= order.paymentStatus %></p>
                  <% if (order.estimatedDelivery) { %>
                    <p><strong>Estimated Delivery:</strong> <%= formatDate(order.estimatedDelivery) %></p>
                  <% } %>
                </div>
              </div>
              <div class="col-md-6">
                <div class="order-info-section">
                  <h5>Shipping Address</h5>
                  <p><strong><%= order.shippingAddress.name %></strong></p>
                  <p><%= order.shippingAddress.house_number %>, <%= order.shippingAddress.street %></p>
                  <p><%= order.shippingAddress.locality %></p>
                  <p><%= order.shippingAddress.city %>, <%= order.shippingAddress.state %></p>
                  <p><strong>PIN:</strong> <%= order.shippingAddress.pincode %></p>
                  <p><strong>Phone:</strong> <%= order.shippingAddress.phone_number %></p>
                </div>
              </div>
            </div>

            
            <h5>Order Items</h5>
            <div class="table-responsive">
              <table class="table">
                <thead>
                  <tr>
                    <th>Product</th>
                    <th>Price</th>
                    <th>Quantity</th>
                    <th>Total</th>
                    <th>Status</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <% order.items.forEach(function(item) { %>
                    <tr class="<%= item.status === 'CANCELLED' ? 'table-secondary' : '' %>">
                      <td>
                        <div class="d-flex align-items-center">
                          <img src="<%= item.image %>" alt="<%= item.name %>" class="me-3 <%= item.status === 'CANCELLED' ? 'opacity-50' : '' %>" style="width: 60px; height: 60px; object-fit: cover;">
                          <div>
                            <h6 class="mb-0 <%= item.status === 'CANCELLED' ? 'text-muted' : '' %>"><%= item.name %></h6>
                            <small class="<%= item.status === 'CANCELLED' ? 'text-muted' : '' %>">Size: <%= item.size %>, Color: <%= item.color %></small>
                          </div>
                        </div>
                      </td>
                      <td class="<%= item.status === 'CANCELLED' ? 'text-muted' : '' %>">
                        <% if (item.status === 'CANCELLED') { %>
                          <s>₹<%= item.price %></s>
                        <% } else { %>
                          ₹<%= item.price %>
                        <% } %>
                      </td>
                      <td class="<%= item.status === 'CANCELLED' ? 'text-muted' : '' %>"><%= item.quantity %></td>
                      <td class="<%= item.status === 'CANCELLED' ? 'text-muted' : '' %>">
                        <% if (item.status === 'CANCELLED') { %>
                          <s>₹<%= item.price * item.quantity %></s>
                        <% } else { %>
                          ₹<%= item.price * item.quantity %>
                        <% } %>
                      </td>
                      <td>
                        <span class="badge bg-<%= item.status === 'RETURNED' ? 'warning' : 
                          (item.status === 'RETURN_REQUESTED' ? 'info' : 
                          (order.status === 'DELIVERED' ? 'success' : 'primary')) %>">
                          <%= item.status || order.status %>
                        </span>
                      </td>
                      <td>
  <% if (item.status === 'CANCELLED') { %>
    <span class="text-muted">Cancelled</span>

  <% } else if (item.status === 'ORDERED' || (order.status === 'ORDERED' && !item.status)) { %>
    <button class="btn btn-danger btn-sm"
            onclick="cancelProduct('<%= order._id %>', '<%= item._id %>')">
      Cancel Item
    </button>

  <% } else if (item.status === 'RETURN_REQUESTED') { %>
    <span class="text-muted">Return Pending</span>

  <% } else if (item.status === 'RETURNED') { %>
    <span class="text-muted">Returned</span>

  <% } else if (item.status === 'DELIVERED' || (order.status === 'DELIVERED' && !item.status)) { %>
    <button class="btn btn-warning btn-sm"
            onclick="requestReturn('<%= order._id %>', '<%= item._id %>')">
      Request Return
    </button>

  <% } %>
</td>

                    </tr>
                  <% }); %>
                </tbody>
              </table>
            </div>

            <!-- Enhanced Cost Breakdown -->
            <div class="row mt-4">
              <div class="col-md-8 ms-auto">
                <div class="card">
                  <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-receipt me-2"></i>Order Summary</h5>
                  </div>
                  <div class="card-body">
                    <%
                      // Calculate totals for active (non-cancelled) items
                      let activeItems = order.items.filter(item => item.status !== 'CANCELLED');
                      let cancelledItems = order.items.filter(item => item.status === 'CANCELLED');
                      let hasCancelledItems = cancelledItems.length > 0;
                      
                      // Active items calculations
                      let activeOriginalTotal = activeItems.reduce((sum, item) => sum + (item.original_price * item.quantity), 0);
                      let activeCurrentTotal = activeItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                      let activeOfferDiscount = activeItems.reduce((sum, item) => sum + ((item.original_price - item.price) * item.quantity), 0);
                      let activeCouponDiscount = activeItems.reduce((sum, item) => sum + (item.coupon_discount_allocated || 0), 0);
                      
                      // Cancelled items calculations
                      let cancelledOriginalTotal = cancelledItems.reduce((sum, item) => sum + (item.original_price * item.quantity), 0);
                      let cancelledOfferDiscount = cancelledItems.reduce((sum, item) => sum + ((item.original_price - item.price) * item.quantity), 0);
                      let cancelledCouponDiscount = cancelledItems.reduce((sum, item) => sum + (item.coupon_discount_allocated || 0), 0);
                      
                      // Calculate proportional shipping based on subtotal value, not item count
                      let totalSubtotal = activeOriginalTotal + cancelledOriginalTotal;
                      let activeShipping = 0;
                      let cancelledShipping = 0;
                      
                      if (totalSubtotal > 0) {
                        let shippingRatio = activeOriginalTotal / totalSubtotal;
                        activeShipping = Math.round(order.shipping_charge * shippingRatio);
                        cancelledShipping = order.shipping_charge - activeShipping;
                      } else {
                        activeShipping = order.shipping_charge;
                      }
                      
                      // Calculate proportional tax based on subtotal value
                      let proportionalTax = 0;
                      if (totalSubtotal > 0 && order.tax > 0) {
                        let taxRatio = activeOriginalTotal / totalSubtotal;
                        proportionalTax = Math.round(order.tax * taxRatio);
                      }
                      
                      // Final totals - handle cancelled items properly
                      let finalTotal;
                      if (hasCancelledItems) {
                        // Recalculate based on active items only
                        finalTotal = Math.round(activeCurrentTotal + activeShipping + proportionalTax - activeCouponDiscount);
                      } else {
                        // Use the backend total if no cancellations (this is the most accurate)
                        finalTotal = Math.round(order.total);
                      }
                      
                      let totalSavings = Math.round(activeOfferDiscount + activeCouponDiscount);
                      
                      // Calculate cancelled amount properly
                      let cancelledAmount = Math.round(cancelledOriginalTotal - cancelledOfferDiscount - cancelledCouponDiscount + cancelledShipping);
                      if (order.tax > 0 && totalSubtotal > 0) {
                        let cancelledTax = Math.round(order.tax * (cancelledOriginalTotal / totalSubtotal));
                        cancelledAmount += cancelledTax;
                      }
                    %>
                    
                    <!-- Enhanced Product-wise breakdown with black and white theme -->
                    <div class="mb-4">
                      <h6 class="text-dark mb-3"><i class="fas fa-list-alt me-2"></i>Detailed Product Breakdown</h6>
                      <% order.items.forEach(function(item, index) { %>
                        <div class="card mb-3" style="border: none; background-color: #f8f9fa; border-radius: 8px;">
                          <div class="card-body p-3" style="background-color: #f8f9fa;">
                            <div class="row align-items-center">
                              <!-- Product Info -->
                              <div class="col-md-6">
                                <div class="d-flex align-items-center">
                                  <img src="<%= item.image %>" alt="<%= item.name %>" 
                                       class="me-3 <%= item.status === 'CANCELLED' ? 'opacity-50' : '' %>" 
                                       style="width: 50px; height: 50px; object-fit: cover; border-radius: 6px; border: 1px solid #e4e7ec;">
                                  <div>
                                    <h6 class="mb-1 <%= item.status === 'CANCELLED' ? 'text-muted' : 'text-dark' %>">
                                      <%= item.name %>
                                      <% if (item.status === 'CANCELLED') { %>
                                        <span class="badge bg-secondary ms-2">Cancelled</span>
                                      <% } %>
                                    </h6>
                                    <small class="text-muted">Size: <%= item.size %> | Color: <%= item.color %> | Qty: <%= item.quantity %></small>
                                  </div>
                                </div>
                              </div>
                              
                              <!-- Price Breakdown -->
                              <div class="col-md-6">
                                <div class="row text-end">
                                  <div class="col-12">
                                    <% 
                                      let originalPrice = item.original_price || item.price;
                                      let finalPrice = item.price;
                                      let quantity = item.quantity;
                                      let offerDiscount = (originalPrice - finalPrice) * quantity;
                                      let couponDiscount = item.coupon_discount_allocated || 0;
                                      let itemSubtotal = originalPrice * quantity;
                                      let itemAfterOffer = finalPrice * quantity;
                                      let itemFinalTotal = itemAfterOffer - couponDiscount;
                                    %>
                                    
                                    <!-- Original Price -->
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                      <small class="text-muted">Original Price:</small>
                                      <span class="<%= item.status === 'CANCELLED' ? 'text-muted' : 'text-dark' %>">
                                        <% if (item.status === 'CANCELLED') { %>
                                          <s>₹<%= Math.round(originalPrice) %> × <%= quantity %> = ₹<%= Math.round(itemSubtotal) %></s>
                                        <% } else { %>
                                          ₹<%= Math.round(originalPrice) %> × <%= quantity %> = ₹<%= Math.round(itemSubtotal) %>
                                        <% } %>
                                      </span>
                                    </div>
                                    
                                    <!-- Product Offer Discount -->
                                    <% if (offerDiscount > 0) { %>
                                      <div class="d-flex justify-content-between align-items-center mb-1">
                                        <small class="text-dark">
                                          <i class="fas fa-tag me-1"></i>Product Offer:
                                        </small>
                                        <span class="text-dark">
                                          <% if (item.status === 'CANCELLED') { %>
                                            <s>-₹<%= Math.round(offerDiscount) %></s>
                                          <% } else { %>
                                            -₹<%= Math.round(offerDiscount) %>
                                            <small class="text-muted">(<%= Math.round((offerDiscount/itemSubtotal)*100) %>% off)</small>
                                          <% } %>
                                        </span>
                                      </div>
                                      
                                      <!-- After Offer Price -->
                                      <div class="d-flex justify-content-between align-items-center mb-1">
                                        <small class="text-muted">After Offer:</small>
                                        <span class="<%= item.status === 'CANCELLED' ? 'text-muted' : 'text-dark' %>">
                                          <% if (item.status === 'CANCELLED') { %>
                                            <s>₹<%= Math.round(itemAfterOffer) %></s>
                                          <% } else { %>
                                            ₹<%= Math.round(itemAfterOffer) %>
                                          <% } %>
                                        </span>
                                      </div>
                                    <% } %>
                                    
                                    <!-- Coupon Discount -->
                                    <% if (couponDiscount > 0) { %>
                                      <div class="d-flex justify-content-between align-items-center mb-1">
                                        <small class="text-dark">
                                          <i class="fas fa-ticket-alt me-1"></i>Coupon Discount:
                                        </small>
                                        <span class="text-dark">
                                          <% if (item.status === 'CANCELLED') { %>
                                            <s>-₹<%= Math.round(couponDiscount) %></s>
                                          <% } else { %>
                                            -₹<%= Math.round(couponDiscount) %>
                                            <% if (order.applied_coupon_code) { %>
                                              <small class="text-muted">(<%= order.applied_coupon_code %>)</small>
                                            <% } %>
                                          <% } %>
                                        </span>
                                      </div>
                                    <% } %>
                                    
                                    <!-- Final Item Total -->
                                    <hr class="my-2" style="border-color: #dee2e6;">
                                    <div class="d-flex justify-content-between align-items-center">
                                      <strong class="<%= item.status === 'CANCELLED' ? 'text-muted' : 'text-dark' %>">
                                        Item Total:
                                      </strong>
                                      <strong class="<%= item.status === 'CANCELLED' ? 'text-muted' : 'text-dark' %>">
                                        <% if (item.status === 'CANCELLED') { %>
                                          <s>₹<%= Math.round(itemFinalTotal) %></s>
                                        <% } else { %>
                                          ₹<%= Math.round(itemFinalTotal) %>
                                        <% } %>
                                      </strong>
                                    </div>
                                    
                                    <!-- Savings Summary for this item -->
                                    <% if ((offerDiscount + couponDiscount) > 0 && item.status !== 'CANCELLED') { %>
                                      <div class="mt-2 p-2" style="background-color: #f8f9fa; border: 1px solid #e9ecef; border-radius: 6px;">
                                        <small class="text-dark">
                                          <i class="fas fa-piggy-bank me-1"></i>
                                          You saved ₹<%= Math.round(offerDiscount + couponDiscount) %> on this item!
                                          <span class="text-muted">
                                            (<%= Math.round(((offerDiscount + couponDiscount)/itemSubtotal)*100) %>% total savings)
                                          </span>
                                        </small>
                                      </div>
                                    <% } %>
                                    
                                    <!-- Refund info for cancelled items -->
                                    <% if (item.status === 'CANCELLED') { %>
                                      <div class="mt-2 p-2" style="background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 6px;">
                                        <small class="text-dark">
                                          <i class="fas fa-info-circle me-1"></i>
                                          Refunded: ₹<%= Math.round((finalPrice * quantity) - couponDiscount) %>
                                          <br>
                                          <span class="text-muted">
                                            (Product price minus used coupon discount)
                                          </span>
                                        </small>
                                      </div>
                                    <% } %>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      <% }); %>
                    </div>
                    
                    <hr>
                    
                    <!-- Summary calculations -->
                    <table class="table table-sm mb-0">
                      <tbody>
                        <% if (hasCancelledItems) { %>
                          <!-- Show original vs current breakdown -->
                          <tr class="text-muted">
                            <td>Original Subtotal</td>
                            <td class="text-end"><s>₹<%= Math.round(activeOriginalTotal + cancelledOriginalTotal) %></s></td>
                          </tr>
                          <tr>
                            <td>Current Subtotal</td>
                            <td class="text-end">₹<%= Math.round(activeCurrentTotal) %></td>
                          </tr>
                          <% if (activeOfferDiscount > 0) { %>
                            <tr class="text-success">
                              <td><i class="fas fa-tag me-1"></i>Product Offers</td>
                              <td class="text-end">-₹<%= Math.round(activeOfferDiscount) %></td>
                            </tr>
                          <% } %>
                          <% if (activeCouponDiscount > 0) { %>
                            <tr class="text-success">
                              <td><i class="fas fa-ticket-alt me-1"></i>Coupon Discount 
                                <% if (order.applied_coupon_code) { %>
                                  <small class="text-muted">(<%= order.applied_coupon_code %>)</small>
                                <% } %>
                              </td>
                              <td class="text-end">-₹<%= Math.round(activeCouponDiscount) %></td>
                            </tr>
                          <% } %>
                          <tr class="text-muted">
                            <td>Original Shipping</td>
                            <td class="text-end"><s>₹<%= Math.round(order.shipping_charge) %></s></td>
                          </tr>
                          <tr>
                            <td>Current Shipping</td>
                            <td class="text-end">₹<%= Math.round(activeShipping) %></td>
                          </tr>
                          <% if (order.tax > 0) { %>
                            <tr>
                              <td>Tax</td>
                              <td class="text-end">₹<%= Math.round(proportionalTax) %></td>
                            </tr>
                          <% } %>
                          <tr class="table-light border-top">
                            <td><strong>Final Total</strong></td>
                            <td class="text-end"><strong>₹<%= Math.round(finalTotal) %></strong></td>
                          </tr>
                          <% if (cancelledItems.length > 0) { %>
                            <tr class="text-muted">
                              <td><small>Cancelled Amount</small></td>
                              <td class="text-end"><small>₹<%= Math.round(cancelledAmount) %></small></td>
                            </tr>
                          <% } %>
                        <% } else { %>
                          <!-- Normal breakdown without cancellations -->
                          <% if (activeOriginalTotal > activeCurrentTotal) { %>
                            <tr class="text-muted">
                              <td>Original Price</td>
                              <td class="text-end">₹<%= Math.round(activeOriginalTotal) %></td>
                            </tr>
                            <% if (activeOfferDiscount > 0) { %>
                              <tr class="text-success">
                                <td><i class="fas fa-tag me-1"></i>Product Offers</td>
                                <td class="text-end">-₹<%= Math.round(activeOfferDiscount) %></td>
                              </tr>
                            <% } %>
                            <tr>
                              <td>Subtotal</td>
                              <td class="text-end">₹<%= Math.round(activeCurrentTotal) %></td>
                            </tr>
                          <% } else { %>
                            <tr>
                              <td>Subtotal</td>
                              <td class="text-end">₹<%= Math.round(activeCurrentTotal) %></td>
                            </tr>
                          <% } %>
                          
                          <% if (activeCouponDiscount > 0) { %>
                            <tr class="text-success">
                              <td><i class="fas fa-ticket-alt me-1"></i>Coupon Discount 
                                <% if (order.applied_coupon_code) { %>
                                  <small class="text-muted">(<%= order.applied_coupon_code %>)</small>
                                <% } %>
                              </td>
                              <td class="text-end">-₹<%= Math.round(activeCouponDiscount) %></td>
                            </tr>
                          <% } %>
                          
                          <% if (activeShipping > 0) { %>
                            <tr>
                              <td><i class="fas fa-shipping-fast me-1"></i>Shipping</td>
                              <td class="text-end">₹<%= Math.round(activeShipping) %></td>
                            </tr>
                          <% } else { %>
                            <tr class="text-success">
                              <td><i class="fas fa-shipping-fast me-1"></i>Shipping</td>
                              <td class="text-end">FREE</td>
                            </tr>
                          <% } %>
                          
                          <% if (order.tax > 0) { %>
                            <tr>
                              <td>Tax</td>
                              <td class="text-end">₹<%= Math.round(order.tax) %></td>
                            </tr>
                          <% } %>
                          
                          <tr class="table-success border-top">
                            <td><strong>Total Amount</strong></td>
                            <td class="text-end"><strong>₹<%= Math.round(finalTotal) %></strong></td>
                          </tr>
                          
                          <% if (totalSavings > 0) { %>
                            <tr class="text-success">
                              <td><small><i class="fas fa-piggy-bank me-1"></i>Total Savings</small></td>
                              <td class="text-end"><small><strong>₹<%= Math.round(totalSavings) %></strong></small></td>
                            </tr>
                          <% } %>
                        <% } %>
                      </tbody>
                    </table>
                    
                    <div class="mt-2">
                      <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        All prices include applicable taxes. 
                        <% if (hasCancelledItems) { %>
                          Cancelled items are refunded to your wallet.
                        <% } %>
                      </small>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
    <%- include('../partials/footer') %>


  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.js"></script>
  <script>
    async function cancelOrder(orderId) {
      const result = await Swal.fire({
        title: 'Cancel Order',
        text: 'Are you sure you want to cancel this order?',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Yes, cancel it',
        cancelButtonText: 'No, keep it',
        confirmButtonColor: '#dc3545',
        cancelButtonColor: '#6c757d'
      });
      
      if (!result.isConfirmed) {
        return;
      }
      
      try {
        const response = await fetch(`/order/cancel/${orderId}`, {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ productId: 'full' })
        });
        
        const data = await response.json();
        if (data.success) {
          await Swal.fire({
            title: 'Order Cancelled',
            text: 'Your order has been cancelled successfully',
            icon: 'success',
            confirmButtonColor: '#28a745'
          });
          window.location.reload();
        } else {
          await Swal.fire({
            title: 'Error',
            text: data.message || 'Failed to cancel order',
            icon: 'error',
            confirmButtonColor: '#dc3545'
          });
        }
      } catch (error) {
        await Swal.fire({
          title: 'Error',
          text: 'An error occurred while cancelling the order',
          icon: 'error',
          confirmButtonColor: '#dc3545'
        });
      }
    }

    async function requestReturn(orderId, itemId) {
      const { value: formValues } = await Swal.fire({
        title: 'Request Return',
        html: `
          <div class="mb-3">
            <label class="form-label">Return Reason</label>
            <select id="returnReason" class="form-select">
              <option value="">Select a reason</option>
              <option value="DAMAGED">Product damaged/defective</option>
              <option value="WRONG_ITEM">Wrong item received</option>
              <option value="SIZE_ISSUE">Size/fit issue</option>
              <option value="QUALITY_ISSUE">Quality not as expected</option>
              <option value="OTHER">Other reason</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Additional Comments</label>
            <textarea id="returnComments" class="form-control" rows="3" placeholder="Please provide more details about your return request"></textarea>
          </div>
        `,
        showCancelButton: true,
        confirmButtonText: 'Submit Return Request',
        cancelButtonText: 'Cancel',
        confirmButtonColor: '#ffc107',
        cancelButtonColor: '#6c757d',
        preConfirm: () => {
          const reason = document.getElementById('returnReason').value;
          const comments = document.getElementById('returnComments').value;
          
          if (!reason) {
            Swal.showValidationMessage('Please select a return reason');
            return false;
          }
          
          return { reason, comments };
        }
      });

      if (!formValues) {
        return;
      }

      try {
        const response = await fetch(`/order/return-request`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            orderId,
            itemId,
            reason: formValues.reason,
            comments: formValues.comments
          })
        });
        
        const data = await response.json();
        if (data.success) {
          await Swal.fire({
            title: 'Return Requested',
            text: 'Your return request has been submitted successfully',
            icon: 'success',
            confirmButtonColor: '#28a745'
          });
          window.location.reload();
        } else {
          await Swal.fire({
            title: 'Error',
            text: data.message || 'Failed to request return',
            icon: 'error',
            confirmButtonColor: '#dc3545'
          });
        }
      } catch (error) {
        await Swal.fire({
          title: 'Error',
          text: 'An error occurred while requesting the return',
          icon: 'error',
          confirmButtonColor: '#dc3545'
        });
      }
    }
  </script>
  <script>
async function cancelProduct(orderId, itemId) {

  const { value: reason } = await Swal.fire({
    title: "Cancel This Product?",
    input: "textarea",
    inputPlaceholder: "Enter cancellation reason",
    inputAttributes: { "aria-label": "Cancellation reason" },
    showCancelButton: true,
    confirmButtonText: "Submit",
    cancelButtonText: "Close",
    preConfirm: (value) => {
      if (!value) {
        Swal.showValidationMessage("Reason is required.");
      }
      return value;
    }
  });

  if (!reason) return;

  try {
    const response = await fetch(`/order/cancel/${orderId}/product`, {
  method: "DELETE",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({ productId: itemId, reason })
});


    const data = await response.json();

    if (data.success) {
      await Swal.fire({
        title: "Item Cancelled",
        text: "This product has been cancelled and amount is added to the wallet",
        icon: "success"
      });
      window.location.reload();
    } else {
      Swal.fire("Error", data.message || "Failed to cancel item", "error");
    }

  } catch (err) {
    Swal.fire("Error", "Something went wrong while cancelling", "error");
  }
}
</script>

  </body>
</html>