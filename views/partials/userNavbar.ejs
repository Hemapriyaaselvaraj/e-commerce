<style>
  .nav-badge {
    position: absolute;
    top: -8px;
    right: -8px;
    background: #dc3545;
    color: white;
    border-radius: 50%;
    width: 18px;
    height: 18px;
    font-size: 11px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    border: 2px solid white;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    z-index: 10;
  }
  
  .nav-icon-container {
    position: relative;
    display: inline-block;
    margin-right: 15px;
    transition: transform 0.2s ease;
  }
  
  .nav-icon-container:hover {
    transform: scale(1.1);
  }
  
  .nav-icon-container i {
    cursor: pointer;
    font-size: 18px;
    color: #333;
    transition: color 0.2s ease;
  }
  
  .nav-icon-container:hover i {
    color: #000;
  }
</style>

<header class="navbar" style="padding-top: 20px; padding-bottom: 20px;">
  <a href="/" class="logo" style="text-decoration:none;color:inherit;font-size:20px;color:#230215;"><strong>ToughToes</strong></a>
  <nav class="nav-links">
    <a href="#" onclick="selectCategory('MEN'); return false;">Men</a>
    <a href="#" onclick="selectCategory('WOMEN'); return false;">Women</a>
    <a href="#" onclick="selectCategory('KIDS'); return false;">Kids</a>
  </nav>
  <div class="nav-right">
    
    <form id="navbarSearchForm" style="display:flex;align-items:center;gap:6px;margin-right:6px;" onsubmit="return false;">
      <input
        type="text"
        name="search"
        id="navbarSearchInput"
        placeholder="Search products..."
        aria-label="Search products"
        value="<%= typeof query !== 'undefined' && query.search ? query.search : '' %>"
        style="padding:6px 8px;border:1px solid #ccc;border-radius:6px;min-width:160px;"
      />
      <button id="navbarSearchBtn" type="button" style="border:none;background:none;color:inherit;cursor:pointer;">
        <i class="fas fa-search"></i>
      </button>
    </form>
    <div class="nav-icon-container">
      <i class="fas fa-shopping-cart" onclick="handleCartClick()"></i>
      <% if (typeof cartCount !== 'undefined' && cartCount > 0) { %>
        <span class="nav-badge"><%= cartCount > 99 ? '99+' : cartCount %></span>
      <% } %>
    </div>
    <div class="nav-icon-container">
      <i class="fas fa-heart" onclick="handleWishlistClick()"></i>
      <% if (typeof wishlistCount !== 'undefined' && wishlistCount > 0) { %>
        <span class="nav-badge"><%= wishlistCount > 99 ? '99+' : wishlistCount %></span>
      <% } %>
    </div>
    <i class="fas fa-user" id="profileIcon" style="cursor:pointer;"></i>
    <% if (typeof name === 'string' && name.trim().length > 0) { %>
      <span><%= name %></span>
    <% } else { %>
      <button id="loginBtn" class="btn btn-dark">Login</button>
    <% } %>
  </div>
</header>

<script>
  function selectCategory(category) {
    window.location.href = '/products?category=' + encodeURIComponent(category);
  }
  
  // Function to handle cart click
  function handleCartClick() {
    const isLoggedIn = <% if (typeof name === 'string' && name.trim().length > 0) { %>true<% } else { %>false<% } %>;
    
    if (isLoggedIn) {
      window.location.href = '/cart';
    } else {
      // Redirect to login page with message
      window.location.href = '/user/login?message=' + encodeURIComponent('Please login to view your cart') + '&redirect=' + encodeURIComponent('/cart');
    }
  }

  // Function to handle wishlist click
  function handleWishlistClick() {
    const isLoggedIn = <% if (typeof name === 'string' && name.trim().length > 0) { %>true<% } else { %>false<% } %>;
    
    if (isLoggedIn) {
      window.location.href = '/wishlist';
    } else {
      // Redirect to login page with message
      window.location.href = '/user/login?message=' + encodeURIComponent('Please login to view your wishlist') + '&redirect=' + encodeURIComponent('/wishlist');
    }
  }
  
  (function() {
    const searchInput = document.getElementById('navbarSearchInput');
    const searchBtn = document.getElementById('navbarSearchBtn');
    function doNavbarSearch() {
      if (!searchInput) return;
      const q = searchInput.value.trim();
      const params = new URLSearchParams(window.location.search);
      if (q.length > 0) {
        params.set('search', q);
      } else {
        params.delete('search');
      }
      
      const qs = params.toString();
      window.location.href = '/products' + (qs ? ('?' + qs) : '');
    }

    if (searchInput) {
      searchInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          doNavbarSearch();
        }
      });
    }

    if (searchBtn) {
      searchBtn.addEventListener('click', doNavbarSearch);
    }
  })();
  
  const loginBtn = document.getElementById("loginBtn");
  if (loginBtn) {
    loginBtn.addEventListener("click", function () {
      window.location.href = "/user/login";
    });
  }

  
  const profileIcon = document.getElementById("profileIcon");
  const isLoggedIn = document.getElementById("loginBtn") == null;
  
  if (profileIcon) {
    profileIcon.addEventListener("click", function() {
      if (isLoggedIn) {
        window.location.href = "/profile";
      } else {
        window.location.href = "/user/login";
      }
    });
  }

  // Function to update navbar counts
  window.updateNavbarCounts = async function() {
    try {
      // Update cart count
      const cartResponse = await fetch('/cart/count');
      const cartData = await cartResponse.json();
      if (cartData.success) {
        updateCartBadge(cartData.count);
      }

      // Update wishlist count
      const wishlistResponse = await fetch('/wishlist/count');
      const wishlistData = await wishlistResponse.json();
      if (wishlistData.success) {
        updateWishlistBadge(wishlistData.count);
      }
    } catch (error) {
      console.error('Error updating navbar counts:', error);
    }
  };

  // Function to update cart badge
  function updateCartBadge(count) {
    const cartContainer = document.querySelector('.nav-icon-container:has(.fa-shopping-cart)');
    if (!cartContainer) return;

    let badge = cartContainer.querySelector('.nav-badge');
    
    if (count > 0) {
      if (!badge) {
        badge = document.createElement('span');
        badge.className = 'nav-badge';
        cartContainer.appendChild(badge);
      }
      badge.textContent = count > 99 ? '99+' : count;
    } else {
      if (badge) {
        badge.remove();
      }
    }
  }

  // Function to update wishlist badge
  function updateWishlistBadge(count) {
    const wishlistContainer = document.querySelector('.nav-icon-container:has(.fa-heart)');
    if (!wishlistContainer) return;

    let badge = wishlistContainer.querySelector('.nav-badge');
    
    if (count > 0) {
      if (!badge) {
        badge = document.createElement('span');
        badge.className = 'nav-badge';
        wishlistContainer.appendChild(badge);
      }
      badge.textContent = count > 99 ? '99+' : count;
    } else {
      if (badge) {
        badge.remove();
      }
    }
  }
</script>
